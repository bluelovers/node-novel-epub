{"version":3,"file":"epub.js","sourceRoot":"","sources":["epub.ts"],"names":[],"mappings":"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","sourcesContent":["import { IForeachArrayDeepReturn, IReturnRow } from 'node-novel-globby';\nimport EpubMaker, { hashSum, ISectionContent, slugify } from 'epub-maker2';\nimport Bluebird = require('bluebird');\nimport { console } from './log';\nimport { fsLowCheckLevelMdconfAsync} from './util';\nimport { htmlPreface } from 'epub-maker2/src/lib/util';\nimport path = require('upath2');\nimport fs = require('fs-iconv');\nimport moment = require('moment');\nimport novelGlobby = require('node-novel-globby/g');\nimport deepmerge = require('deepmerge-plus');\nimport { crlf, LF } from 'crlf-normalize';\nimport { chkInfo, IMdconfMeta, mdconf_parse } from 'node-novel-info';\nimport { EnumEpubTypeName } from 'epub-maker2/src/epub-types';\nimport { INovelEpubReturnInfo, IOptions } from './txt2epub3';\nimport { array_unique } from 'array-hyper-unique';\nimport { EpubStore, handleAttachFile } from './store';\nimport {\n\tIInternalProcessEpubOptions,\n\tIInternalProcessOptions,\n\tIInternalProcessVolumeOptions,\n\tIResolvableBluebird,\n} from './types';\nimport { splitTxt } from './html';\nimport { ITSResolvable, ITSPartialWith, ITSUnpackedPromiseLike, ITSRequiredWith } from 'ts-type';\nimport { handleMarkdown } from './md';\n\nexport const SymCache = Symbol('cache');\n\nexport const enum EnumPrefixIDType\n{\n\tVOLUME = 'volume',\n\tCHAPTER = 'chapter',\n\tIMAGE = 'image',\n\tCONTRIBUTE = 'contribute',\n}\n\nexport const enum EnumPrefixIDTitle\n{\n\tIMAGE = '插圖',\n\tCONTRIBUTE = 'CONTRIBUTE',\n}\n\nexport interface IEpubRuntimeReturnCacheVolumeRow\n{\n\tvol_key: string,\n\tdirname: string,\n\tvalue: IReturnRow,\n}\n\nexport type IEpubRuntimeReturn = IForeachArrayDeepReturn<IReturnRow, any, {\n\tstat: INovelEpubReturnInfo[\"stat\"],\n}, {\n\tcache_vol: {\n\t\t[vol: string]: number;\n\t},\n\n\tcache_volume_row: IEpubRuntimeReturnCacheVolumeRow[];\n\n\tcache_top_subs: {\n\t\t[k: string]: Omit<IEpubRuntimeReturnCacheVolumeRow, 'value'>[]\n\t};\n\n\tprev_volume_row?: IEpubRuntimeReturnCacheVolumeRow,\n\n\tprev_volume_title: string,\n\tprev_volume_dir: string,\n\n\tcount_idx: number,\n\tcount_f: number,\n\tcount_d: number,\n\n\tcacheTreeSection: Record<string, EpubMaker.Section>,\n\n\tprev_volume?: EpubMaker.Section,\n\n\t_new_top_level?: EpubMaker.Section,\n\t_old_top_level?: EpubMaker.Section,\n\n}>;\n\nexport function _handleVolume(volume: EpubMaker.Section, dirname: string, _data_: IInternalProcessVolumeOptions)\n{\n\treturn Bluebird\n\t\t.resolve(null)\n\t\t.then(async function ()\n\t\t{\n\t\t\tconst { processReturn, epub } = _data_;\n\t\t\tconst { stat } = processReturn.data;\n\n\t\t\tlet vid: string = volume.id;\n\n\t\t\tif (!volume[SymCache].cover)\n\t\t\t{\n\t\t\t\tvolume[SymCache].cover = true;\n\n\t\t\t\tlet file = path.join(dirname, 'README.md');\n\n\t\t\t\tlet meta = await fsLowCheckLevelMdconfAsync(file).catch(e => null);\n\n\t\t\t\t//console.log(file, meta);\n\n\t\t\t\tawait Bluebird.resolve(novelGlobby.globby([\n\t\t\t\t\t\t'cover.*',\n\t\t\t\t\t], {\n\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\tabsolute: true,\n\t\t\t\t\t}))\n\t\t\t\t\t.then(async (ls) =>\n\t\t\t\t\t{\n\t\t\t\t\t\tif (ls.length)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet ext = path.extname(ls[0]);\n\t\t\t\t\t\t\tlet name = `${vid}-cover${ext}`;\n\n\t\t\t\t\t\t\tepub.withAdditionalFile(ls[0], null, name);\n\n\t\t\t\t\t\t\treturn name;\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse if (fs.existsSync(file))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (meta && meta.novel)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (meta.novel.cover)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlet ext = '.png';\n\t\t\t\t\t\t\t\t\tlet basename = `${vid}-cover`;\n\t\t\t\t\t\t\t\t\tlet name = `${basename}${ext}`;\n\n\t\t\t\t\t\t\t\t\tlet data = typeof meta.novel.cover === 'string' ? {\n\t\t\t\t\t\t\t\t\t\turl: meta.novel.cover,\n\t\t\t\t\t\t\t\t\t} : meta.novel.cover;\n\n\t\t\t\t\t\t\t\t\tdata.ext = null;\n\t\t\t\t\t\t\t\t\tdata.basename = basename;\n\n\t\t\t\t\t\t\t\t\tepub.withAdditionalFile(data, null, name);\n\n\t\t\t\t\t\t\t\t\treturn name;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t.then(function (name)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet _ok = false;\n\t\t\t\t\t\tlet data: ISectionContent = {};\n\n\t\t\t\t\t\tif (name)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t_ok = true;\n\t\t\t\t\t\t\tdata.cover = {\n\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tstat.image += 1;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (meta && meta.novel)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tif (meta.novel.preface)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t_ok = true;\n\t\t\t\t\t\t\t\t//data.content = crlf(meta.novel.preface);\n\n\t\t\t\t\t\t\t\tdata.content = htmlPreface({\n\t\t\t\t\t\t\t\t\tinfoPreface: meta.novel.preface,\n\t\t\t\t\t\t\t\t}).infoPrefaceHTML;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//console.log(name, _ok);\n\n\t\t\t\t\t\tif (_ok)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\treturn data\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn null\n\t\t\t\t\t})\n\t\t\t\t\t.tap(function (data)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (data)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t//console.log(volume);\n\n\t\t\t\t\t\t\tvolume.setContent(data, true);\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t;\n\t\t\t}\n\t\t})\n\t\t;\n}\n\nexport function makePrefixID(count_idx: number, prefix: EnumPrefixIDType)\n{\n\treturn `${prefix}${(count_idx).toString().padStart(6, '0')}`;\n}\n\nexport function makeVolumeID(count_idx: number)\n{\n\treturn makePrefixID(count_idx, EnumPrefixIDType.VOLUME);\n}\n\nexport function makeChapterID(count_idx: number)\n{\n\treturn makePrefixID(count_idx, EnumPrefixIDType.CHAPTER);\n}\n\nexport interface IAttachMetaData\n{\n\timages: Record<string, string>\n}\n\nexport function getAttachMeta(dirname: string): Promise<IAttachMetaData>\n{\n\treturn fsLowCheckLevelMdconfAsync(path.join(dirname, 'ATTACH.md'))\n\t\t.then<IAttachMetaData>((v: IMdconfMeta & {\n\t\t\tattach: IAttachMetaData\n\t\t}) =>\n\t\t{\n\t\t\tif (v.attach)\n\t\t\t{\n\t\t\t\treturn v.attach\n\t\t\t}\n\t\t\t// @ts-ignore\n\t\t\telse if (v.novel && v.novel.attach)\n\t\t\t{\n\t\t\t\t// @ts-ignore\n\t\t\t\treturn v.novel.attach as any as IAttachMetaData\n\t\t\t}\n\n\t\t\treturn v as any as IAttachMetaData\n\t\t})\n\t\t.then(attach => {\n\n\t\t\tif (attach && attach.images)\n\t\t\t{\n\t\t\t\tattach.images = Object.entries(attach.images)\n\t\t\t\t\t.reduce((a, [k, v]) => {\n\n\t\t\t\t\t\ta[k] = v;\n\n\t\t\t\t\t\tlet k2 = k.toString().toLowerCase();\n\n\t\t\t\t\t\tif (a[k2] == null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta[k2] = v;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tk2 = k2.toUpperCase();\n\n\t\t\t\t\t\tif (a[k2] == null)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\ta[k2] = v;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn a;\n\t\t\t\t\t}, {})\n\t\t\t}\n\n\t\t\treturn attach\n\t\t})\n\t\t.catch(e => null as IAttachMetaData)\n\t\t;\n}\n\nconst AttachMetaMap = new Map<string, IAttachMetaData>();\n\nexport async function getAttachMetaByRow(row: IReturnRow)\n{\n\tif (!AttachMetaMap.has(row.path_dir))\n\t{\n\t\tlet data = await getAttachMeta(row.path_dir);\n\n\t\tAttachMetaMap.set(row.path_dir, data);\n\t}\n\n\treturn AttachMetaMap.get(row.path_dir)\n}\n\nexport function _handleVolumeImage(volume: EpubMaker.Section, dirname: string, _data_: IInternalProcessVolumeOptions)\n{\n\treturn Bluebird.resolve(null)\n\t\t.then(async function ()\n\t\t{\n\t\t\tif (volume[SymCache].image)\n\t\t\t{\n\t\t\t\treturn [] as string[];\n\t\t\t}\n\n\t\t\tconst { processReturn, epub, epubOptions, store, cwdRoot } = _data_;\n\t\t\tconst { stat } = processReturn.data;\n\n\t\t\tconst vid: string = volume.id;\n\n\t\t\tvolume[SymCache].image = true;\n\n\t\t\treturn novelGlobby.globby([\n\t\t\t\t\t'*.{jpg,gif,png,jpeg,svg,webp,apng}',\n\t\t\t\t\t'image/*.{jpg,gif,png,jpeg,svg,webp,apng}',\n\t\t\t\t\t'images/*.{jpg,gif,png,jpeg,svg,webp,apng}',\n\t\t\t\t\t'!cover.*',\n\t\t\t\t\t'!*.txt',\n\t\t\t\t], {\n\t\t\t\t\tcwd: dirname,\n\t\t\t\t\tabsolute: true,\n\t\t\t\t})\n\t\t\t\t.then(async (ls) =>\n\t\t\t\t{\n\t\t\t\t\tlet arr: string[] = [];\n\n\t\t\t\t\tfor (let i in ls)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet img = ls[i];\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tlet ext = path.extname(img);\n\n\t\t\t\t\t\tlet basename = path.basename(img, ext);\n\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\tlet name = slugify(basename);\n\n\t\t\t\t\t\tif (!name || arr.includes(name))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tname = hashSum([img, i, name]);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//name = `${vid}/${i}-` + name + ext;\n\t\t\t\t\t\tname = `${vid}/` + name + ext;\n\n\t\t\t\t\t\tarr.push('image/' + name);\n\n\t\t\t\t\t\tepub.withAdditionalFile(img, 'image', name);\n\t\t\t\t\t\t */\n\n\t\t\t\t\t\tlet ret = handleAttachFile(img, {\n\t\t\t\t\t\t\tvid,\n\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\tepubOptions,\n\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\tbasePath: 'image',\n\t\t\t\t\t\t\tfailbackExt: '.jpg',\n\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\tcwdRoot,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (ret)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tarr.push(ret.returnPath);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tlet md_attach = await getAttachMeta(dirname);\n\n\t\t\t\t\tif (md_attach && (md_attach.images))\n\t\t\t\t\t{\n\t\t\t\t\t\tObject.values(md_attach.images)\n\t\t\t\t\t\t\t.forEach(v =>\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (v)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlet ret = handleAttachFile(v, {\n\t\t\t\t\t\t\t\t\t\tvid,\n\t\t\t\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\t\t\t\tepubOptions,\n\t\t\t\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\t\t\t\tbasePath: 'image',\n\t\t\t\t\t\t\t\t\t\tfailbackExt: '.jpg',\n\t\t\t\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\t\t\t\tcwdRoot,\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\tif (ret)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tarr.push(ret.returnPath);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\t\t\t\t\t}\n\n\t\t\t\t\tarr = array_unique(arr);\n\n\t\t\t\t\tif (arr.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (volume.content && volume.content.cover && volume.content.cover.name)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tarr.unshift(volume.content.cover.name);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet chapter = new EpubMaker.Section(EnumEpubTypeName.NON_SPECIFIC_BACKMATTER, makePrefixID(processReturn.temp.count_idx++, EnumPrefixIDType.IMAGE), {\n\t\t\t\t\t\t\ttitle: EnumPrefixIDTitle.IMAGE,\n\t\t\t\t\t\t\tcontent: arr.reduce(function (a, b)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlet html = htmlImage(b);\n\n\t\t\t\t\t\t\t\ta.push(html);\n\n\t\t\t\t\t\t\t\treturn a;\n\t\t\t\t\t\t\t}, []).join(LF),\n\t\t\t\t\t\t}, true, false);\n\n\t\t\t\t\t\tstat.image += arr.length;\n\n\t\t\t\t\t\tvolume.withSubSection(chapter);\n\t\t\t\t\t}\n\n\t\t\t\t\treturn ls;\n\t\t\t\t})\n\t\t\t\t;\n\t\t})\n\t\t;\n}\n\nexport function htmlImage(src: string)\n{\n\treturn `<figure class=\"fullpage ImageContainer page-break-before\"><img id=\"CoverImage\" class=\"CoverImage\" src=\"${src}\" alt=\"Cover\" /></figure>`;\n}\n\nexport function _handleVolumeImageEach(ls: Omit<IEpubRuntimeReturnCacheVolumeRow, 'value'>[], _data_: IInternalProcessVolumeOptions)\n{\n\tconst { processReturn, epub, store, epubOptions, cwd } = _data_;\n\tconst temp = processReturn.temp;\n\n\treturn Bluebird\n\t\t.resolve(array_unique(ls))\n\t\t.mapSeries(async function (row: Omit<IEpubRuntimeReturnCacheVolumeRow, 'value'>)\n\t\t{\n\t\t\tlet key = row.vol_key;\n\t\t\tlet volume = temp.cacheTreeSection[key];\n\n\t\t\treturn _handleVolumeImage(volume, row.dirname, _data_)\n\t\t\t\t.tap(function (ls)\n\t\t\t\t{\n\t\t\t\t\tif (0 && ls.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tconsole.log({\n\t\t\t\t\t\t\tvolume,\n\t\t\t\t\t\t\tls,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t;\n\t\t})\n\t\t;\n}\n\nexport function _hookAfterVolume(ls: IEpubRuntimeReturn[\"temp\"][\"cache_volume_row\"],\n\t_data_: IInternalProcessVolumeOptions,\n\tafterVolumeTasks: ((volume: EpubMaker.Section, dirname: string, _data_: IInternalProcessVolumeOptions, row: IEpubRuntimeReturnCacheVolumeRow) => IResolvableBluebird<unknown>)[],\n)\n{\n\tconst { processReturn, epub, store, epubOptions, cwd } = _data_;\n\tconst temp = processReturn.temp;\n\n\tls = array_unique(ls);\n\n\treturn Bluebird\n\t\t.resolve(ls)\n\t\t.mapSeries(async function (row: IEpubRuntimeReturnCacheVolumeRow, index)\n\t\t{\n\t\t\tlet key = row.vol_key;\n\t\t\tlet volume = temp.cacheTreeSection[key];\n\n\t\t\treturn Bluebird.props({\n\t\t\t\tindex,\n\t\t\t\trow,\n\n\t\t\t\tvolume,\n\n\t\t\t\tmapData: Bluebird.mapSeries(afterVolumeTasks, async (fn, index) => {\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tindex,\n\t\t\t\t\t\tfn,\n\t\t\t\t\t\tret: await fn(volume, row.dirname, _data_, row as IEpubRuntimeReturnCacheVolumeRow),\n\t\t\t\t\t};\n\t\t\t\t})\n\t\t\t});\n\t\t})\n\t\t;\n}\n\nexport function _hookAfterEpub(epub: EpubMaker,\n\t_data_: IInternalProcessEpubOptions,\n\tafterEpubTasks: ((epub: EpubMaker, _data_: IInternalProcessEpubOptions) => IResolvableBluebird<unknown>)[],\n)\n{\n\treturn Bluebird\n\t\t.resolve(epub)\n\t\t.then(async function (epub)\n\t\t{\n\t\t\treturn Bluebird.props({\n\n\t\t\t\tepub,\n\n\t\t\t\tmapData: Bluebird.mapSeries(afterEpubTasks, async (fn, index) => {\n\n\t\t\t\t\treturn {\n\t\t\t\t\t\tindex,\n\t\t\t\t\t\tfn,\n\t\t\t\t\t\tret: await fn(epub, _data_),\n\t\t\t\t\t};\n\t\t\t\t})\n\t\t\t});\n\t\t})\n\t\t;\n}\n\nexport function addContributeSection(volume: EpubMaker.Section, dirname: string, _data_: IInternalProcessVolumeOptions, row: IEpubRuntimeReturnCacheVolumeRow)\n{\n\treturn Bluebird.resolve(volume)\n\t\t.then(async (volume) => {\n\n\t\t\tif (volume[SymCache].contribute != null)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvolume[SymCache].contribute = false;\n\n\t\t\treturn novelGlobby.globby([\n\t\t\t\t'CONTRIBUTE.md',\n\t\t\t], {\n\t\t\t\tcwd: dirname,\n\t\t\t\tabsolute: true,\n\t\t\t\tdeep: 0,\n\t\t\t})\n\t\t\t\t.then(async (ls) => {\n\n\t\t\t\t\tif (ls.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst vid: string = volume.id;\n\t\t\t\t\t\tconst attach = await getAttachMetaByRow(row.value);\n\n\t\t\t\t\t\tconst { processReturn } = _data_;\n\n\t\t\t\t\t\tlet file = ls[0];\n\n\t\t\t\t\t\tlet source = await fs.readFile(file);\n\n\t\t\t\t\t\tlet mdReturn = handleMarkdown(source, {\n\t\t\t\t\t\t\t..._data_,\n\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\tvid,\n\t\t\t\t\t\t\tattach,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tlet chapter = createContributeSection({\n\t\t\t\t\t\t\ttarget: volume,\n\t\t\t\t\t\t\tmdReturn,\n\t\t\t\t\t\t\tprocessReturn,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\treturn volume[SymCache].contribute = true\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t;\n\t\t})\n\t;\n}\n\nexport function createContributeSection(options : {\n\ttarget: EpubMaker.Section | EpubMaker,\n\tmdReturn: ReturnType<typeof handleMarkdown>,\n\tprocessReturn: Partial<IEpubRuntimeReturn>,\n})\n{\n\tconst { target, mdReturn, processReturn } = options;\n\n\tlet title = mdReturn.mdEnv.title || EnumPrefixIDTitle.CONTRIBUTE;\n\n\tlet chapter = new EpubMaker.Section(EnumEpubTypeName.NON_SPECIFIC_BACKMATTER, makePrefixID(processReturn.temp.count_idx++, EnumPrefixIDType.CONTRIBUTE), {\n\t\ttitle,\n\t\tcontent: mdReturn.mdHtml,\n\t}, true, false);\n\n\tif (target instanceof EpubMaker)\n\t{\n\t\ttarget.withSection(chapter);\n\t}\n\telse\n\t{\n\t\ttarget.withSubSection(chapter);\n\t}\n\n\treturn chapter\n}\n"]}