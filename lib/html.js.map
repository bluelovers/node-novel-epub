{"version":3,"file":"html.js","sourceRoot":"","sources":["html.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2019/7/9.\n */\n\nimport { IInternalProcessContextOptions } from './types';\nimport { IAttachMetaData } from './epub';\nimport { cn2tw_min, tw2cn_min } from 'cjk-conv/lib/zh/convert/min';\nimport { _fixRubyInnerContext, allowedHtmlTagList, reTxtHtmlTag, reTxtImgTag } from './tags';\nimport { getAttachID, handleAttachFile } from './store';\nimport { toHalfWidth, toFullWidth } from 'str-util';\nimport { console } from './log';\nimport { parse as parseNodeNovelTxtTag } from '@node-novel/parse-txt-tag';\n\nexport function novelImage(src: string, options: {\n\tfailback?: string,\n\tattr?: string,\n} = {})\n{\n\tlet { failback = '', attr = '' } = options || {};\n\n\tif (failback && failback.length)\n\t{\n\t\tfailback = ` lowsrc=\"${failback}\" `;\n\t}\n\telse\n\t{\n\t\tfailback = '';\n\t}\n\n\treturn `<figure class=\"fullpage ImageContainer page-break-before duokan-image-single\"><div><img src=\"${src}\" class=\"inner-image\" ${failback} ${attr}/></div></figure>`;\n}\n\nexport function splitTxt(txt, plusData?: IInternalProcessContextOptions)\n{\n\tconst { attach = {} as IAttachMetaData, store, vid, epub, epubOptions, cwd } = plusData || {};\n\tconst { images } = attach || {} as IAttachMetaData;\n\n\tif (epubOptions.iconv)\n\t{\n\t\tif (epubOptions.iconv === 'cn')\n\t\t{\n\t\t\ttxt = tw2cn_min(txt)\n\t\t}\n\t\telse if (epubOptions.iconv === 'tw')\n\t\t{\n\t\t\ttxt = cn2tw_min(txt)\n\t\t}\n\t}\n\n\tlet context: string = txt\n\t\t.toString()\n\t\t.replace(/\\r\\n|\\r(?!\\n)|\\n/g, \"\\n\")\n\n\t\t.replace(/\\u003C/g, '&lt;')\n\t\t.replace(/\\u003E/g, '&gt;')\n\n\t\t.replace(/&lt;(img[^\\n]+?)\\/?&gt;/gm, function (...m)\n\t\t{\n\t\t\t//console.log(m);\n\n\t\t\treturn `<${m[1].replace(/\\/+$/, '')} class=\"inner-image\"/>`;\n\t\t})\n\t;\n\n\tcontext = parseNodeNovelTxtTag(context, {\n\t\ton:{\n\t\t\timg({\n\t\t\t\ttagName,\n\t\t\t\tinnerContext,\n\t\t\t})\n\t\t\t{\n\t\t\t\tif (images && store && innerContext)\n\t\t\t\t{\n\t\t\t\t\tlet { id, input } = getAttachID(innerContext, {\n\t\t\t\t\t\timages,\n\t\t\t\t\t});\n\n\t\t\t\t\tif (input)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet ret = handleAttachFile(input, {\n\t\t\t\t\t\t\t...plusData,\n\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\tepubOptions,\n\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\tvid,\n\t\t\t\t\t\t\tfailbackExt: '.jpg',\n\t\t\t\t\t\t\tbasePath: 'image',\n\t\t\t\t\t\t\tcwd,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (ret)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet _options: Parameters<typeof novelImage>[\"1\"] = {\n\t\t\t\t\t\t\t\tattr: ` alt=\"（插圖${toFullWidth(id)}）\"`,\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (ret.ok && !ret.isFile)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t_options.failback = ret.input;\n\n\t\t\t\t\t\t\t\treturn novelImage(ret.returnPath, _options);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn novelImage(ret.returnPath, _options);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tconsole.warn(`ID( ${innerContext} )，不存在於附件表內`);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tconsole.warn(`偵測到 ID( ${innerContext} )，但附件表不存在`);\n\t\t\t\t}\n\n\t\t\t\treturn null;\n\t\t\t},\n\t\t\tdefault({\n\t\t\t\ttagName,\n\t\t\t\tattr,\n\t\t\t\tinnerContext,\n\t\t\t\tcache,\n\t\t\t\tattach,\n\t\t\t})\n\t\t\t{\n\t\t\t\tif (tagName !== 'img' && !allowedHtmlTagList.includes(tagName))\n\t\t\t\t{\n\t\t\t\t\tconsole.warn(`not support ${tagName}`, attr, innerContext)\n\t\t\t\t}\n\n\t\t\t\treturn null\n\t\t\t},\n\t\t}\n\t}).context;\n\n\tcontext = ('<div>' + context\n\t\t.replace(/^[ ]*[－＝\\-—\\=─–]{3,}[ ]*$/mg, '<hr/>')\n\n\t\t//.replace(/^([－＝\\-—\\=─═─＝=══－\\-─—◆◇]+)$/mg, '<span class=\"overflow-line\">$1</span>')\n\n\t\t.replace(/\\n/g, '</div>\\n<div>')\n\t\t+ '</div>')\n\n\t\t.replace(/<div><hr\\/><\\/div>/g, '<hr class=\"linehr\"/>')\n\n\t\t.replace(/<div>[ ]*([－＝—=─═─＝=══－\\-─—～◆◇\\*＊\\+＊＊↣◇◆☆★■□☆◊▃\\p{Punctuation}]+)[ ]*<\\/div>/ug, '<div class=\"linegroup calibre1 overflow-line\">$1</div>')\n\n\t\t.replace(/<div><\\/div>/g, '<div class=\"linegroup softbreak\">　 </div>')\n\t\t.replace(/<div>/g, '<div class=\"linegroup calibre1\">')\n\t;\n\n\treturn context;\n}\n\nexport default splitTxt\n"]}