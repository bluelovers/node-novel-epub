{"version":3,"file":"html.js","sourceRoot":"","sources":["html.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2019/7/9.\n */\n\nimport { IInternalProcessContextOptions } from './types';\nimport { IAttachMetaData } from './epub';\nimport { cn2tw_min, tw2cn_min } from 'cjk-conv/lib/zh/convert/min';\nimport { _fixRubyInnerContext, allowedHtmlTagList, reTxtHtmlTag, reTxtImgTag } from './tags';\nimport { getAttachID, handleAttachFile } from './store';\nimport { toHalfWidth, toFullWidth } from 'str-util';\nimport { console } from './log';\n\nexport function novelImage(src: string, options: {\n\tfailback?: string,\n\tattr?: string,\n} = {})\n{\n\tlet { failback = '', attr = '' } = options || {};\n\n\tif (failback && failback.length)\n\t{\n\t\tfailback = ` lowsrc=\"${failback}\" `;\n\t}\n\telse\n\t{\n\t\tfailback = '';\n\t}\n\n\treturn `<figure class=\"fullpage ImageContainer page-break-before duokan-image-single\"><div><img src=\"${src}\" class=\"inner-image\" ${failback} ${attr}/></div></figure>`;\n}\n\nexport function splitTxt(txt, plusData?: IInternalProcessContextOptions)\n{\n\tconst { attach = {} as IAttachMetaData, store, vid, epub, epubOptions, cwd } = plusData || {};\n\tconst { images } = attach || {} as IAttachMetaData;\n\n\tif (epubOptions.iconv)\n\t{\n\t\tif (epubOptions.iconv === 'cn')\n\t\t{\n\t\t\ttxt = tw2cn_min(txt)\n\t\t}\n\t\telse if (epubOptions.iconv === 'tw')\n\t\t{\n\t\t\ttxt = cn2tw_min(txt)\n\t\t}\n\t}\n\n\treturn (\n\t\t'<div>' +\n\t\ttxt\n\t\t\t.toString()\n\t\t\t.replace(/\\r\\n|\\r(?!\\n)|\\n/g, \"\\n\")\n\n\t\t\t.replace(/\\u003C/g, '&lt;')\n\t\t\t.replace(/\\u003E/g, '&gt;')\n\n\t\t\t.replace(/&lt;(img[^\\n]+?)\\/?&gt;/gm, function (...m)\n\t\t\t{\n\t\t\t\t//console.log(m);\n\n\t\t\t\treturn `<${m[1].replace(/\\/+$/, '')} class=\"inner-image\"/>`;\n\t\t\t})\n\n\t\t\t.replace(reTxtImgTag, (s, id: string) =>\n\t\t\t{\n\n\t\t\t\tif (images && store && id)\n\t\t\t\t{\n\t\t\t\t\tlet input: string;\n\n\t\t\t\t\t({ id, input } = getAttachID(id, {\n\t\t\t\t\t\timages,\n\t\t\t\t\t}));\n\n\t\t\t\t\tif (input)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet ret = handleAttachFile(input, {\n\t\t\t\t\t\t\t...plusData,\n\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\tepubOptions,\n\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\tvid,\n\t\t\t\t\t\t\tfailbackExt: '.jpg',\n\t\t\t\t\t\t\tbasePath: 'image',\n\t\t\t\t\t\t\tcwd,\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (ret)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet _options: Parameters<typeof novelImage>[\"1\"] = {\n\t\t\t\t\t\t\t\tattr: ` alt=\"（插圖${toFullWidth(id)}）\"`\n\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\tif (ret.ok && !ret.isFile)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t_options.failback = ret.input;\n\n\t\t\t\t\t\t\t\treturn novelImage(ret.returnPath, _options);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn novelImage(ret.returnPath, _options);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\treturn s;\n\t\t\t})\n\n\t\t\t.replace(reTxtHtmlTag, (s, ...argv) =>\n\t\t\t{\n\n\t\t\t\tlet [tagName = '', attr = '', innerContext = ''] = argv as string[];\n\n\t\t\t\ttagName = toHalfWidth(tagName).toLowerCase();\n\n\t\t\t\tswitch (tagName as (typeof allowedHtmlTagList)[number])\n\t\t\t\t{\n\t\t\t\t\tcase 's':\n\t\t\t\t\tcase 'i':\n\t\t\t\t\tcase 'b':\n\t\t\t\t\tcase 'sup':\n\t\t\t\t\tcase 'sub':\n\t\t\t\t\t\treturn `<${tagName}>` + innerContext + `</${tagName}>`;\n\t\t\t\t\tcase 'ruby':\n\t\t\t\t\t\treturn '<ruby>' + _fixRubyInnerContext(innerContext) + '</ruby>';\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tconsole.warn(`not support ${tagName}`, argv, s)\n\t\t\t\t}\n\n\t\t\t\treturn s;\n\t\t\t})\n\n\t\t\t.replace(/^[ ]*[－＝\\-—\\=─–]{3,}[ ]*$/mg, '<hr/>')\n\n\t\t\t//.replace(/^([－＝\\-—\\=─═─＝=══－\\-─—◆◇]+)$/mg, '<span class=\"overflow-line\">$1</span>')\n\n\t\t\t.replace(/\\n/g, '</div>\\n<div>')\n\t\t+ '</div>')\n\n\t\t.replace(/<div><hr\\/><\\/div>/g, '<hr class=\"linehr\"/>')\n\n\t\t.replace(/<div>[ ]*([－＝—=─═─＝=══－\\-─—～◆◇\\*＊\\+＊＊↣◇◆☆★■□☆◊▃\\p{Punctuation}]+)[ ]*<\\/div>/ug, '<div class=\"linegroup calibre1 overflow-line\">$1</div>')\n\n\t\t.replace(/<div><\\/div>/g, '<div class=\"linegroup softbreak\">　 </div>')\n\t\t.replace(/<div>/g, '<div class=\"linegroup calibre1\">')\n\t\t;\n}"]}