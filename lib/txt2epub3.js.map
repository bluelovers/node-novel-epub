{"version":3,"file":"txt2epub3.js","sourceRoot":"","sources":["txt2epub3.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2017/12/16/016.\n */\n\nimport { ISectionContent } from 'epub-maker2/src/index';\nimport { htmlPreface } from 'epub-maker2/src/lib/util';\nimport * as fs from 'fs-iconv';\nimport EpubMaker, { hashSum, slugify } from 'epub-maker2';\nimport Promise = require('bluebird');\nimport * as path from 'upath2';\nimport * as StrUtil from 'str-util';\nimport * as moment from 'moment';\nimport * as novelGlobby from 'node-novel-globby';\nimport { mdconf_parse, IMdconfMeta, chkInfo, getNovelTitleFromMeta } from 'node-novel-info';\nimport { splitTxt } from './util';\nimport { createUUID } from 'epub-maker2/src/lib/uuid';\nimport deepmerge = require('deepmerge-plus');\nimport { normalize_strip } from '@node-novel/normalize';\nimport { Console } from 'debug-color2';\nimport { crlf } from 'crlf-normalize';\nimport { EnumEpubConfigVertical } from 'epub-maker2/src/config';\n\nexport const console = new Console(null, {\n\tenabled: true,\n\tinspectOptions: {\n\t\tcolors: true,\n\t},\n\tchalkOptions: {\n\t\tenabled: true,\n\t},\n});\n\nconsole.enabledColor = true;\n\nexport interface IOptions\n{\n\t/**\n\t * 小說 txt 的主資料夾路徑\n\t * @type {string}\n\t */\n\tinputPath: string,\n\toutputPath: string,\n\n\t/**\n\t * 小說名稱ID\n\t */\n\tnovelID?: string,\n\tfilename?: string,\n\n\tnovelConf?,\n\n\tepubTemplate?,\n\n\tepubLanguage?: string,\n\n\tpadEndDate?: boolean,\n\n\tglobbyOptions?: novelGlobby.IOptions,\n\n\tuseTitle?: boolean,\n\tfilenameLocal?: boolean | string[] | string,\n\n\tnoLog?: boolean,\n\n\tvertical?: boolean | EnumEpubConfigVertical;\n}\n\nexport const defaultOptions: Partial<IOptions> = Object.freeze({\n\tepubTemplate: 'lightnovel',\n\t//epubLanguage: 'zh',\n\tepubLanguage: 'zh-Hant-TW',\n\t//padEndDate: true,\n\n\tglobbyOptions: {\n\t\tcheckRoman: true,\n\t\tuseDefaultPatternsExclude: true,\n\t},\n});\n\nexport function getNovelConf(options: IOptions, cache = {}): Promise<IMdconfMeta>\n{\n\treturn Promise.resolve().then(async function ()\n\t{\n\t\tlet meta: IMdconfMeta;\n\t\tlet confPath: string;\n\n\t\tif (options.novelConf && typeof options.novelConf == 'object')\n\t\t{\n\t\t\tmeta = options.novelConf;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tif (typeof options.novelConf == 'string')\n\t\t\t{\n\t\t\t\tconfPath = options.novelConf;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tconfPath = options.inputPath;\n\t\t\t}\n\n\t\t\tif (fs.existsSync(path.join(confPath, 'meta.md')))\n\t\t\t{\n\t\t\t\tlet file = path.join(confPath, 'meta.md');\n\n\t\t\t\tmeta = await fs.readFile(file)\n\t\t\t\t\t.then(mdconf_parse)\n\t\t\t\t;\n\t\t\t}\n\t\t\telse if (fs.existsSync(path.join(confPath, 'README.md')))\n\t\t\t{\n\t\t\t\tlet file = path.join(confPath, 'README.md');\n\n\t\t\t\tmeta = await fs.readFile(file)\n\t\t\t\t\t.then(mdconf_parse)\n\t\t\t\t;\n\t\t\t}\n\t\t}\n\n\t\tmeta = chkInfo(meta);\n\n\t\tif (!meta || !meta.novel || !meta.novel.title)\n\t\t{\n\t\t\tthrow new Error(`not a valid novelInfo data`);\n\t\t}\n\n\t\treturn meta;\n\t})\n}\n\nexport function makeOptions(options: IOptions)\n{\n\toptions = Object.keys(options)\n\t\t.filter(v => typeof options[v] != 'undefined')\n\t\t.reduce(function (a, b)\n\t\t{\n\t\t\ta[b] = options[b];\n\n\t\t\treturn a\n\t\t}, {} as IOptions)\n\t;\n\n\treturn options = deepmerge.all([{}, defaultOptions, options]);\n}\n\nexport interface INovelEpubReturnInfo\n{\n\tfile: string,\n\tfilename: string,\n\tepub: EpubMaker,\n\n\toutputPath: string,\n\tbasename: string,\n\text: string,\n\n\tstat: {\n\t\tvolume: number,\n\t\tchapter: number,\n\t\timage: number,\n\t},\n}\n\nexport function create(options: IOptions, cache = {}): Promise<INovelEpubReturnInfo>\n{\n\treturn Promise.resolve().then(async function ()\n\t{\n\t\t//console.log(options, defaultOptions);\n\n\t\toptions = makeOptions(options);\n\n\t\t//console.dir(options, {colors: true});\n\n\t\tlet novelID = options.novelID;\n\t\tlet TXT_PATH = options.inputPath;\n\n\t\tlet meta = await getNovelConf(options, cache);\n\n\t\tlet globby_patterns: string[];\n\t\tlet globby_options: novelGlobby.IOptions = Object.assign({}, options.globbyOptions, {\n\t\t\tcwd: TXT_PATH,\n\t\t\t//useDefaultPatternsExclude: true,\n\t\t\t//checkRoman: true,\n\t\t});\n\n\t\t{\n\t\t\t[globby_patterns, globby_options] = novelGlobby.getOptions(globby_options);\n\t\t}\n\n\t\t//console.log(options, globby_options);\n\n\t\t//console.dir(options);\n\n\t\tconsole.info(meta.novel.title);\n\t\t//console.log(meta.novel.preface);\n\n\t\tlet epub: EpubMaker = new EpubMaker()\n\t\t\t.withTemplate(options.epubTemplate)\n\t\t\t.withLanguage(options.epubLanguage)\n\t\t\t.withUuid(createUUID(hashSum([\n\t\t\t\tmeta.novel.title,\n\t\t\t\tmeta.novel.author,\n\t\t\t])))\n\t\t\t.withTitle(meta.novel.title, meta.novel.title_short || meta.novel.title_zh)\n\t\t\t.withAuthor(meta.novel.author)\n\t\t\t.addAuthor(meta.novel.author)\n\t\t\t.withCollection({\n\t\t\t\tname: meta.novel.title,\n\t\t\t})\n\t\t\t.withInfoPreface(meta.novel.preface)\n\t\t\t.addTag(meta.novel.tags)\n\t\t\t.addAuthor(meta.contribute)\n\t\t;\n\n\t\tif (options.vertical)\n\t\t{\n\t\t\tepub.setVertical(options.vertical);\n\t\t}\n\n\t\tlet titles = getNovelTitleFromMeta(meta);\n\t\tif (titles && titles.length)\n\t\t{\n\t\t\tepub.addTitles(titles);\n\t\t}\n\n\t\tif (options.filename)\n\t\t{\n\t\t\tepub.epubConfig.filename = options.filename;\n\t\t}\n\n\t\tif (meta.novel.source)\n\t\t{\n\t\t\tepub.addLinks(meta.novel.source);\n\t\t}\n\n\t\tif (meta.novel.series)\n\t\t{\n\t\t\tepub.withSeries(meta.novel.series.name, meta.novel.series.position);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tepub.withSeries(meta.novel.title);\n\t\t}\n\n\t\tif (meta.novel.publisher)\n\t\t{\n\t\t\tepub.withPublisher(meta.novel.publisher || 'node-novel');\n\t\t}\n\n\t\tif (meta.novel.date)\n\t\t{\n\t\t\tepub.withModificationDate(meta.novel.date);\n\t\t}\n\n\t\tif (meta.novel.status)\n\t\t{\n\t\t\tepub.addTag(meta.novel.status);\n\t\t}\n\n\t\tif (meta.novel.cover)\n\t\t{\n\t\t\tepub.withCover(meta.novel.cover);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tawait novelGlobby.globby([\n\t\t\t\t\t'cover.*',\n\t\t\t\t], Object.assign({}, globby_options, {\n\t\t\t\t\tabsolute: true,\n\t\t\t\t}))\n\t\t\t\t.then(ls =>\n\t\t\t\t{\n\t\t\t\t\tif (ls.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tepub.withCover(ls[0]);\n\t\t\t\t\t}\n\n\t\t\t\t\tconsole.log(ls);\n\t\t\t\t})\n\t\t\t;\n\t\t}\n\n\t\t//process.exit();\n\n\t\tlet stat: INovelEpubReturnInfo[\"stat\"] = {\n\t\t\tvolume: 0,\n\t\t\tchapter: 0,\n\t\t\timage: 0,\n\t\t};\n\n\t\tawait novelGlobby\n\t\t\t.globbyASync(globby_patterns, globby_options)\n\t\t\t.then(function (ls)\n\t\t\t{\n\t\t\t\t//console.log(ls);\n\n\t\t\t\t//process.exit();\n\n\t\t\t\treturn ls;\n\t\t\t})\n\t\t\t.then(_ls =>\n\t\t\t{\n\t\t\t\tlet idx = 1;\n\n\t\t\t\tlet cacheTreeSection = {} as {\n\t\t\t\t\t[k: string]: EpubMaker.Section,\n\t\t\t\t};\n\n\t\t\t\tconst SymCache = Symbol('cache');\n\n\t\t\t\tlet _new_top_level: EpubMaker.Section;\n\t\t\t\tlet _old_top_level: EpubMaker.Section;\n\n\t\t\t\treturn Promise\n\t\t\t\t\t.mapSeries(Object.keys(_ls), async function (val_dir)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet ls = _ls[val_dir];\n\t\t\t\t\t\tlet dirname = ls[0].path_dir;\n\t\t\t\t\t\tlet volume_title = ls[0].volume_title;\n\n\t\t\t\t\t\tlet volume = cacheTreeSection[val_dir];\n\n\t\t\t\t\t\tif (!cacheTreeSection[val_dir])\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet _ts2 = volume_title.split('/');\n\t\t\t\t\t\t\tlet _ts = val_dir.split('/');\n\n\t\t\t\t\t\t\tlet _ds = (path.normalize(dirname) as string).split('/');\n\n\t\t\t\t\t\t\tlet _last: EpubMaker.Section;\n\n\t\t\t\t\t\t\tfor (let i = 0; i < _ts.length; i++)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlet _navs = _ts.slice(0, i + 1);\n\t\t\t\t\t\t\t\tlet _nav = _navs.join('/');\n\n\t\t\t\t\t\t\t\tlet _nav_dir = _ds.slice(0, _ds.length - _ts.length + i + 1).join('/');\n\n\t\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\tconsole.dir({\n\t\t\t\t\t\t\t\t\ti,\n\t\t\t\t\t\t\t\t\t_navs,\n\t\t\t\t\t\t\t\t\t_nav,\n\t\t\t\t\t\t\t\t\t_nav_dir,\n\t\t\t\t\t\t\t\t\tlen: _ts.length,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t*/\n\n\t\t\t\t\t\t\t\tif (i < (_ts.length - 1))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_nav += '.dir';\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (!cacheTreeSection[_nav])\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlet vid = `volume${(idx++).toString().padStart(6, '0')}`;\n\n\t\t\t\t\t\t\t\t\tlet title = normalize_strip(_ts2[i], true);\n\n\t\t\t\t\t\t\t\t\tcacheTreeSection[_nav] = new EpubMaker.Section('auto-toc', vid, {\n\t\t\t\t\t\t\t\t\t\ttitle: title,\n\t\t\t\t\t\t\t\t\t}, false, true);\n\n\t\t\t\t\t\t\t\t\tcacheTreeSection[_nav][SymCache] = cacheTreeSection[_nav][SymCache] || {};\n\n\t\t\t\t\t\t\t\t\tif (i == 0)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t//epub.withSection(cacheTreeSection[_nav]);\n\n\t\t\t\t\t\t\t\t\t\t_old_top_level = _new_top_level;\n\t\t\t\t\t\t\t\t\t\t_new_top_level = cacheTreeSection[_nav];\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tstat.volume++;\n\n\t\t\t\t\t\t\t\t\t//console.log(_nav, cacheTreeSection[_nav].content.title);\n\n\t\t\t\t\t\t\t\t\tawait _handleVolume(cacheTreeSection[_nav], _nav_dir)\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\tif (_last && !_last.hasSubSection(cacheTreeSection[_nav]))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t_last.withSubSection(cacheTreeSection[_nav])\n\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t_last = cacheTreeSection[_nav];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvolume = cacheTreeSection[val_dir];\n\n//\t\t\t\t\t\t\tconsole.dir({\n//\t\t\t\t\t\t\t\tcacheTreeSection,\n//\t\t\t\t\t\t\t\tvolume,\n//\t\t\t\t\t\t\t}, {\n//\t\t\t\t\t\t\t\tdepth: 5,\n//\t\t\t\t\t\t\t\tcolors: true,\n//\t\t\t\t\t\t\t});\n//\t\t\t\t\t\t\tprocess.exit()\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tlet vid: string = volume.id;\n\n\t\t\t\t\t\tawait _handleVolume(volume, dirname);\n\n\t\t\t\t\t\tasync function _handleVolume(volume: EpubMaker.Section, dirname: string)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet vid: string = volume.id;\n\n\t\t\t\t\t\t\tif (!volume[SymCache].cover)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvolume[SymCache].cover = true;\n\n\t\t\t\t\t\t\t\tlet file = path.join(dirname, 'README.md');\n\t\t\t\t\t\t\t\tlet meta = await fs.readFile(file)\n\t\t\t\t\t\t\t\t\t.then(function (data)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\treturn mdconf_parse(data, {\n\t\t\t\t\t\t\t\t\t\t\t// 當沒有包含必要的內容時不產生錯誤\n\t\t\t\t\t\t\t\t\t\t\tthrow: false,\n\t\t\t\t\t\t\t\t\t\t\t// 允許不標準的 info 內容\n\t\t\t\t\t\t\t\t\t\t\tlowCheckLevel: true,\n\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.catch(function ()\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\treturn null;\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t;\n\n\t\t\t\t\t\t\t\t//console.log(file, meta);\n\n\t\t\t\t\t\t\t\tawait novelGlobby.globby([\n\t\t\t\t\t\t\t\t\t\t'cover.*',\n\t\t\t\t\t\t\t\t\t], {\n\t\t\t\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\t\t\t\tabsolute: true,\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.then(async (ls) =>\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tif (ls.length)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tlet ext = path.extname(ls[0]);\n\t\t\t\t\t\t\t\t\t\t\tlet name = `${vid}-cover${ext}`;\n\n\t\t\t\t\t\t\t\t\t\t\tepub.withAdditionalFile(ls[0], null, name);\n\n\t\t\t\t\t\t\t\t\t\t\treturn name;\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\telse if (fs.existsSync(file))\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tif (meta && meta.novel)\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tif (meta.novel.cover)\n\t\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t\tlet ext = '.png';\n\t\t\t\t\t\t\t\t\t\t\t\t\tlet basename = `${vid}-cover`;\n\t\t\t\t\t\t\t\t\t\t\t\t\tlet name = `${basename}${ext}`;\n\n\t\t\t\t\t\t\t\t\t\t\t\t\tlet data = typeof meta.novel.cover === 'string' ? {\n\t\t\t\t\t\t\t\t\t\t\t\t\t\turl: meta.novel.cover,\n\t\t\t\t\t\t\t\t\t\t\t\t\t} : meta.novel.cover;\n\n\t\t\t\t\t\t\t\t\t\t\t\t\tdata.ext = null;\n\t\t\t\t\t\t\t\t\t\t\t\t\tdata.basename = basename;\n\n\t\t\t\t\t\t\t\t\t\t\t\t\tepub.withAdditionalFile(data, null, name);\n\n\t\t\t\t\t\t\t\t\t\t\t\t\treturn name;\n\t\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.then(function (name)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tlet _ok = false;\n\t\t\t\t\t\t\t\t\t\tlet data: ISectionContent = {};\n\n\t\t\t\t\t\t\t\t\t\tif (name)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t_ok = true;\n\t\t\t\t\t\t\t\t\t\t\tdata.cover = {\n\t\t\t\t\t\t\t\t\t\t\t\tname,\n\t\t\t\t\t\t\t\t\t\t\t};\n\n\t\t\t\t\t\t\t\t\t\t\tstat.image += 1;\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tif (meta && meta.novel)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tif (meta.novel.preface)\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\t_ok = true;\n\t\t\t\t\t\t\t\t\t\t\t\t//data.content = crlf(meta.novel.preface);\n\n\t\t\t\t\t\t\t\t\t\t\t\tdata.content = htmlPreface({\n\t\t\t\t\t\t\t\t\t\t\t\t\tinfoPreface: meta.novel.preface,\n\t\t\t\t\t\t\t\t\t\t\t\t}).infoPrefaceHTML;\n\t\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t//console.log(name, _ok);\n\n\t\t\t\t\t\t\t\t\t\tif (_ok)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\treturn data\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\treturn null\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.then(function (data)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tif (data)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t//console.log(volume);\n\n\t\t\t\t\t\t\t\t\t\t\tvolume.setContent(data, true);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//console.log(dirname, volume.id);\n\n\t\t\t\t\t\t//volume.withSubSection(new EpubMaker.Section('auto-toc', null, null, false, false));\n\n\t\t\t\t\t\tawait Promise.mapSeries(ls, async function (row)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\t//console.log(filename);\n\n\t\t\t\t\t\t\t//let data = await fs.readFile(path.join(TXT_PATH, dirname, filename));\n\t\t\t\t\t\t\tlet data: string | Buffer = await fs.readFile(row.path);\n\n\t\t\t\t\t\t\t//console.log(data);\n\n\t\t\t\t\t\t\tif (row.ext == '.txt')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdata = splitTxt(data.toString());\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (Buffer.isBuffer(data))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tdata = data.toString();\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tlet name = row.chapter_title;\n\n\t\t\t\t\t\t\tif (!options.noLog)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlet {\n\t\t\t\t\t\t\t\t\tsource_idx,\n\t\t\t\t\t\t\t\t\tvolume_title,\n\t\t\t\t\t\t\t\t\tchapter_title,\n\t\t\t\t\t\t\t\t\tdir,\n\t\t\t\t\t\t\t\t\tfile,\n\t\t\t\t\t\t\t\t} = row;\n\n\t\t\t\t\t\t\t\tconsole.dir({\n\t\t\t\t\t\t\t\t\tsource_idx,\n\t\t\t\t\t\t\t\t\tvolume_title,\n\t\t\t\t\t\t\t\t\tchapter_title,\n\t\t\t\t\t\t\t\t\tdir,\n\t\t\t\t\t\t\t\t\tfile,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tlet chapter = new EpubMaker.Section('chapter', `chapter${(idx++).toString()\n\t\t\t\t\t\t\t\t.padStart(4, '0')}`, {\n\t\t\t\t\t\t\t\ttitle: name,\n\t\t\t\t\t\t\t\tcontent: crlf(data),\n\t\t\t\t\t\t\t}, true, false);\n\n\t\t\t\t\t\t\tstat.chapter++;\n\n\t\t\t\t\t\t\tvolume.withSubSection(chapter);\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tif (!volume[SymCache].image)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tvolume[SymCache].image = true;\n\n\t\t\t\t\t\t\tawait novelGlobby.globby([\n\t\t\t\t\t\t\t\t\t'*.{jpg,gif,png,jpeg,svg}',\n\t\t\t\t\t\t\t\t\t'image/*.{jpg,gif,png,jpeg,svg}',\n\t\t\t\t\t\t\t\t\t'images/*.{jpg,gif,png,jpeg,svg}',\n\t\t\t\t\t\t\t\t\t'!cover.*',\n\t\t\t\t\t\t\t\t\t'!*.txt',\n\t\t\t\t\t\t\t\t], {\n\t\t\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\t\t\tabsolute: true,\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t.then(ls =>\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlet arr = [];\n\n\t\t\t\t\t\t\t\t\tfor (let i in ls)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tlet img = ls[i];\n\n\t\t\t\t\t\t\t\t\t\tlet ext = path.extname(img);\n\n\t\t\t\t\t\t\t\t\t\tlet basename = path.basename(img, ext);\n\n\t\t\t\t\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\t\t\t\t\tlet name = slugify(basename);\n\n\t\t\t\t\t\t\t\t\t\tif (!name || arr.includes(name))\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tname = hashSum([img, i, name]);\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\t//name = `${vid}/${i}-` + name + ext;\n\t\t\t\t\t\t\t\t\t\tname = `${vid}/` + name + ext;\n\n\t\t\t\t\t\t\t\t\t\tarr.push('image/' + name);\n\n\t\t\t\t\t\t\t\t\t\tepub.withAdditionalFile(img, 'image', name);\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\tif (arr.length)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tif (volume.content && volume.content.cover && volume.content.cover.name)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tarr.unshift(volume.content.cover.name);\n\t\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\t\tlet chapter = new EpubMaker.Section('non-specific backmatter', `image${(idx++).toString()\n\t\t\t\t\t\t\t\t\t\t\t.padStart(4, '0')}`, {\n\t\t\t\t\t\t\t\t\t\t\ttitle: '插圖',\n\t\t\t\t\t\t\t\t\t\t\tcontent: arr.reduce(function (a, b)\n\t\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\t\tlet html = `<figure class=\"fullpage ImageContainer page-break-before\"><img id=\"CoverImage\" class=\"CoverImage\" src=\"${b}\" alt=\"Cover\" /></figure>`;\n\n\t\t\t\t\t\t\t\t\t\t\t\ta.push(html);\n\n\t\t\t\t\t\t\t\t\t\t\t\treturn a;\n\t\t\t\t\t\t\t\t\t\t\t}, []).join(\"\\n\"),\n\t\t\t\t\t\t\t\t\t\t}, true, false);\n\n\t\t\t\t\t\t\t\t\t\tstat.image += arr.length;\n\n\t\t\t\t\t\t\t\t\t\tvolume.withSubSection(chapter);\n\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t//epub.withSection(volume);\n\n\t\t\t\t\t\tif (_old_top_level && _old_top_level != _new_top_level && !epub.hasSection(_old_top_level))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tepub.withSection(_old_top_level);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\treturn volume;\n\t\t\t\t\t})\n\t\t\t\t\t.tap(function ()\n\t\t\t\t\t{\n\t\t\t\t\t\tif (_new_top_level && !epub.hasSection(_new_top_level))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tepub.withSection(_new_top_level);\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t;\n\t\t\t})\n\t\t;\n\n\t\t//console.dir(epub.epubConfig.sections[0]);\n\t\t//console.dir(epub.epubConfig.landmarks.slice(0, 2));\n\t\t//process.exit();\n\n\t\tlet data = await epub.makeEpub();\n\n\t\tlet _file_data = makeFilename(options, epub, meta);\n\n\t\tlet { file, filename, now, basename, ext } = _file_data;\n\n\t\tawait fs.outputFile(file, data);\n\n\t\tconsole.success(filename, now.format());\n\n\t\treturn {\n\t\t\tfile,\n\t\t\tfilename,\n\t\t\tepub,\n\n\t\t\toutputPath: options.outputPath,\n\n\t\t\tbasename,\n\t\t\text,\n\n\t\t\tstat,\n\t\t};\n\t});\n}\n\nexport function makeFilename(options: IOptions, epub: EpubMaker, meta: IMdconfMeta)\n{\n\toptions = makeOptions(options);\n\n\tlet filename = epub.getFilename(options.useTitle, true);\n\n\tif (!options.filename)\n\t{\n\t\tif (options.filenameLocal)\n\t\t{\n\t\t\t// @ts-ignore\n\t\t\tif (meta.novel.title_output)\n\t\t\t{\n\t\t\t\t// @ts-ignore\n\t\t\t\tfilename = meta.novel.title_output;\n\t\t\t}\n\t\t\telse if (Array.isArray(options.filenameLocal))\n\t\t\t{\n\t\t\t\tfor (let v of options.filenameLocal)\n\t\t\t\t{\n\t\t\t\t\tif (meta.novel[v])\n\t\t\t\t\t{\n\t\t\t\t\t\tfilename = meta.novel[v];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (meta.novel.title_zh)\n\t\t\t{\n\t\t\t\tfilename = meta.novel.title_zh;\n\t\t\t}\n\t\t\telse if (meta.novel.title_short)\n\t\t\t{\n\t\t\t\tfilename = meta.novel.title_short;\n\t\t\t}\n\t\t\telse if (meta.novel.title_tw)\n\t\t\t{\n\t\t\t\tfilename = meta.novel.title_tw;\n\t\t\t}\n\t\t\telse if (typeof options.filenameLocal == 'string')\n\t\t\t{\n\t\t\t\tfilename = options.filenameLocal;\n\t\t\t}\n\t\t}\n\t}\n\n\tconst basename = filename;\n\n\tlet ext = EpubMaker.defaultExt;\n\n\tlet now = moment();\n\n\tif (options.padEndDate)\n\t{\n\t\tfilename += '_' + now.format('YYYYMMDD_HHmmss');\n\t}\n\n\tfilename += ext;\n\n\tlet file = path.join(options.outputPath, filename);\n\n\treturn {\n\t\tfile,\n\t\text,\n\t\tfilename,\n\t\toptions,\n\t\tnow,\n\t\tbasename,\n\t\tepub,\n\t\tmeta,\n\t}\n}\n\nexport default create;\n"]}