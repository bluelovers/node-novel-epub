{"version":3,"file":"txt2epub3.js","sourceRoot":"","sources":["txt2epub3.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2017/12/16/016.\n */\n\nimport { ISectionContent } from 'epub-maker2/src/index';\nimport { htmlPreface } from 'epub-maker2/src/lib/util';\nimport EpubMaker, { hashSum, slugify } from 'epub-maker2';\nimport { array_unique, chkInfo, IMdconfMeta, mdconf_parse } from 'node-novel-info';\nimport { fsLowCheckLevelMdconfAsync, pathDirNormalize } from './util';\nimport { console } from './log';\nimport { createUUID } from 'epub-maker2/src/lib/uuid';\nimport { normalize_strip } from '@node-novel/normalize';\nimport { Console } from 'debug-color2';\nimport { crlf } from 'crlf-normalize';\nimport { EnumEpubConfigVertical } from 'epub-maker2/src/config';\nimport { NodeNovelInfo } from 'node-novel-info/class';\nimport { sortTree } from 'node-novel-globby/lib/glob-sort';\nimport { eachVolumeTitle, foreachArrayDeepAsync, IArrayDeepInterface, IReturnRow } from 'node-novel-globby';\nimport { EnumEpubTypeName } from 'epub-maker2/src/epub-types';\nimport {\n\t_handleVolume,\n\t_handleVolumeImage,\n\t_handleVolumeImageEach,\n\t_hookAfterEpub,\n\t_hookAfterVolume,\n\taddContributeSection,\n\tcreateContributeSection,\n\tgetAttachMetaByRow,\n\tIEpubRuntimeReturn,\n\tmakeChapterID,\n\tmakeVolumeID,\n\tSymCache,\n\tIEpubMakerSectionWithCache, addMarkdown, EnumPrefixIDType, EnumPrefixIDTitle, createMarkdownSection,\n} from './epub';\nimport fs = require('fs-iconv');\nimport Bluebird = require('bluebird');\nimport path = require('upath2');\nimport moment = require('moment');\nimport novelGlobby = require('node-novel-globby/g');\nimport deepmerge = require('deepmerge-plus');\nimport { inspect } from 'util';\nimport { EpubStore } from './store';\nimport { splitTxt } from './html';\nimport { handleMarkdown } from './md';\nimport { createEpubContextDate, EPUB_CONTEXT_DATE } from '@node-novel/epub-util/lib/const';\n\nexport { console }\n\nexport interface IOptions\n{\n\t/**\n\t * 小說 txt 的主資料夾路徑\n\t * @type {string}\n\t */\n\tinputPath: string,\n\toutputPath: string,\n\n\t/**\n\t * 小說名稱ID\n\t */\n\tnovelID?: string,\n\tfilename?: string,\n\n\tnovelConf?: unknown,\n\n\tepubTemplate?: unknown,\n\n\tepubLanguage?: string,\n\n\tpadEndDate?: boolean,\n\n\tglobbyOptions?: novelGlobby.IOptions,\n\n\tuseTitle?: boolean,\n\tfilenameLocal?: boolean | string[] | string,\n\n\tnoLog?: boolean,\n\n\t/**\n\t * 是否直排\n\t */\n\tvertical?: boolean | EnumEpubConfigVertical,\n\n\t/**\n\t * 下載網路資源\n\t */\n\tdownloadRemoteFile?: boolean,\n\n\ticonv?: string | 'cn' | 'tw' | 'chs' | 'cht' | 'zhs' | 'zht',\n\n\t/**\n\t * 允許指定 epub 內的檔案更新日期\n\t */\n\tepubContextDate?: moment.MomentInput | Date | moment.Moment | true;\n}\n\nexport const defaultOptions: Partial<IOptions> = Object.freeze({\n\tepubTemplate: 'lightnovel',\n\t//epubLanguage: 'zh',\n\tepubLanguage: 'zh-Hant-TW',\n\t//padEndDate: true,\n\n\tglobbyOptions: {\n\t\tcheckRoman: true,\n\t\tuseDefaultPatternsExclude: true,\n\t},\n});\n\nexport function getNovelConf(options: IOptions, cache = {}): Bluebird<IMdconfMeta>\n{\n\treturn Bluebird.resolve().then(async function ()\n\t\t{\n\t\t\tlet meta: IMdconfMeta;\n\t\t\tlet confPath: string;\n\n\t\t\tif (options.novelConf && typeof options.novelConf == 'object')\n\t\t\t{\n\t\t\t\tmeta = options.novelConf;\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tif (typeof options.novelConf == 'string')\n\t\t\t\t{\n\t\t\t\t\tconfPath = options.novelConf;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tconfPath = options.inputPath;\n\t\t\t\t}\n\n\t\t\t\tif (fs.existsSync(path.join(confPath, 'meta.md')))\n\t\t\t\t{\n\t\t\t\t\tlet file = path.join(confPath, 'meta.md');\n\n\t\t\t\t\tmeta = await fs.readFile(file)\n\t\t\t\t\t\t.then(mdconf_parse)\n\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t\telse if (fs.existsSync(path.join(confPath, 'README.md')))\n\t\t\t\t{\n\t\t\t\t\tlet file = path.join(confPath, 'README.md');\n\n\t\t\t\t\tmeta = await fs.readFile(file)\n\t\t\t\t\t\t.then(mdconf_parse)\n\t\t\t\t\t;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tmeta = chkInfo(meta);\n\n\t\t\treturn meta;\n\t\t})\n\t\t.catch((e: Error) =>\n\t\t{\n\n\t\t\tif (e.message == 'Error: mdconf_parse' || e.message == 'mdconf_parse')\n\t\t\t{\n\t\t\t\treturn null\n\t\t\t}\n\n\t\t\treturn Bluebird.reject(e)\n\t\t})\n\t\t.tap(meta =>\n\t\t{\n\n\t\t\tif (!meta || !meta.novel || !meta.novel.title)\n\t\t\t{\n\t\t\t\tthrow new Error(`not a valid novelInfo data, ${inspect(options)}`);\n\t\t\t}\n\n\t\t\treturn meta;\n\t\t})\n}\n\nexport function makeOptions(options: IOptions): IOptions\n{\n\toptions = Object.keys(options)\n\t\t.filter(v => typeof options[v] != 'undefined')\n\t\t.reduce(function (a, b)\n\t\t{\n\t\t\ta[b] = options[b];\n\n\t\t\treturn a\n\t\t}, {} as IOptions)\n\t;\n\n\toptions = deepmerge.all([{}, defaultOptions, options]);\n\n\tif (options.iconv)\n\t{\n\t\tswitch (options.iconv)\n\t\t{\n\t\t\tcase 'chs':\n\t\t\tcase 'cn':\n\t\t\tcase 'zhs':\n\t\t\t\toptions.iconv = 'cn';\n\t\t\t\tbreak;\n\t\t\tcase 'cht':\n\t\t\tcase 'tw':\n\t\t\tcase 'zht':\n\t\t\t\toptions.iconv = 'tw';\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn options\n}\n\nexport interface INovelEpubReturnInfo\n{\n\tfile: string,\n\tfilename: string,\n\tepub: EpubMaker,\n\n\toutputPath: string,\n\tbasename: string,\n\text: string,\n\n\tstat: {\n\t\tvolume: number,\n\t\tchapter: number,\n\t\timage: number,\n\t},\n\n\tstore: EpubStore,\n}\n\nexport function create(options: IOptions, cache = {}): Bluebird<INovelEpubReturnInfo>\n{\n\treturn Bluebird.resolve().then(async function ()\n\t{\n\t\t//console.log(options, defaultOptions);\n\n\t\toptions = makeOptions(options);\n\n\t\t//console.dir(options, {colors: true});\n\n\t\tconst novelID = options.novelID;\n\t\tconst TXT_PATH = pathDirNormalize(options.inputPath);\n\n\t\tlet meta = await getNovelConf(options, cache);\n\n\t\tconst metaLib = new NodeNovelInfo(meta, {\n\t\t\tthrow: false,\n\t\t\tlowCheckLevel: true,\n\t\t});\n\n\t\tlet globby_patterns: string[];\n\t\tlet globby_options: novelGlobby.IOptions = Object.assign({}, options.globbyOptions, {\n\t\t\tcwd: TXT_PATH,\n\t\t\t//useDefaultPatternsExclude: true,\n\t\t\t//checkRoman: true,\n\t\t});\n\n\t\t{\n\t\t\t[globby_patterns, globby_options] = novelGlobby.getOptions2(globby_options);\n\t\t}\n\n\t\t//console.log(options, globby_options);\n\n\t\t//console.dir(options);\n\n\t\tconsole.info(meta.novel.title);\n\t\t//console.log(meta.novel.preface);\n\n\t\tlet epub: EpubMaker = new EpubMaker()\n\t\t\t.withTemplate(options.epubTemplate)\n\t\t\t.withLanguage(options.epubLanguage)\n\t\t\t.withUuid(createUUID(hashSum([\n\t\t\t\tmeta.novel.title,\n\t\t\t\tmeta.novel.author,\n\t\t\t])))\n\t\t\t.withTitle(meta.novel.title, meta.novel.title_short || meta.novel.title_zh)\n\t\t\t.withAuthor(meta.novel.author)\n\t\t\t.addAuthor(meta.novel.author)\n\t\t\t.withCollection({\n\t\t\t\tname: meta.novel.title,\n\t\t\t})\n\t\t\t.withInfoPreface(meta.novel.preface)\n\t\t\t.addTag(metaLib.tags())\n\t\t\t.addAuthor(metaLib.contributes())\n\t\t;\n\n\t\tif (options.vertical)\n\t\t{\n\t\t\tepub.setVertical(options.vertical);\n\t\t}\n\n\t\tepub.addTitles(metaLib.titles());\n\n\t\tif (options.filename)\n\t\t{\n\t\t\tepub.epubConfig.filename = options.filename;\n\t\t}\n\n\t\tmetaLib.sources()\n\t\t\t.forEach(link => epub.addLinks(link))\n\t\t;\n\n\t\tif (meta.novel.series)\n\t\t{\n\t\t\tepub.withSeries(meta.novel.series.name, meta.novel.series.position);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tepub.withSeries(meta.novel.title);\n\t\t}\n\n\t\tif (meta.novel.publisher)\n\t\t{\n\t\t\tepub.withPublisher(meta.novel.publisher || 'node-novel');\n\t\t}\n\n\t\tif (meta.novel.date)\n\t\t{\n\t\t\tepub.withModificationDate(meta.novel.date);\n\t\t}\n\n\t\tif (meta.novel.status)\n\t\t{\n\t\t\tepub.addTag(meta.novel.status);\n\t\t}\n\n\t\tif (meta.novel.cover)\n\t\t{\n\t\t\tepub.withCover(meta.novel.cover);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tawait novelGlobby.globby([\n\t\t\t\t\t'cover.*',\n\t\t\t\t], Object.assign({}, globby_options, {\n\t\t\t\t\tabsolute: true,\n\t\t\t\t}))\n\t\t\t\t.then(ls =>\n\t\t\t\t{\n\t\t\t\t\tif (ls.length)\n\t\t\t\t\t{\n\t\t\t\t\t\tepub.withCover(ls[0]);\n\t\t\t\t\t}\n\n\t\t\t\t\tconsole.log(ls);\n\t\t\t\t})\n\t\t\t;\n\t\t}\n\n\t\tif (options.epubContextDate)\n\t\t{\n\t\t\tif (typeof options.epubContextDate == 'boolean')\n\t\t\t{\n\t\t\t\toptions.epubContextDate = createEpubContextDate();\n\t\t\t}\n\n\t\t\tepub.withContextDate(options.epubContextDate);\n\t\t}\n\n\t\t//process.exit();\n\n\t\tconst store = new EpubStore();\n\n\t\tlet count_idx = 0;\n\n\t\t{\n\t\t\tlet file = path.join(TXT_PATH, 'FOREWORD.md');\n\n\t\t\tif (fs.pathExistsSync(file))\n\t\t\t{\n\t\t\t\tlet source = await fs.readFile(file);\n\n\t\t\t\tlet mdReturn = handleMarkdown(source, {\n\t\t\t\t\tcwd: TXT_PATH,\n\t\t\t\t});\n\n\t\t\t\tcreateMarkdownSection({\n\t\t\t\t\ttarget: epub,\n\t\t\t\t\tmdReturn,\n\t\t\t\t\tprocessReturn: {\n\t\t\t\t\t\t// @ts-ignore\n\t\t\t\t\t\ttemp: {\n\t\t\t\t\t\t\tcount_idx,\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\n\t\t\t\t\tepubType: EnumEpubTypeName.FOREWORD,\n\t\t\t\t\tepubTitle: EnumPrefixIDTitle.FOREWORD,\n\t\t\t\t\tepubPrefix: EnumPrefixIDType.FOREWORD,\n\t\t\t\t});\n\n\t\t\t\tcount_idx++;\n\t\t\t}\n\t\t};\n\n\t\tconst processReturn = await novelGlobby\n\t\t\t.globbyASync(globby_patterns, globby_options)\n\t\t\t.tap(function (ls)\n\t\t\t{\n\t\t\t\treturn ls;\n\t\t\t})\n\t\t\t.then(function (ls)\n\t\t\t{\n\t\t\t\treturn sortTree(ls, null, globby_options)\n\t\t\t})\n\t\t\t.then(function (ls)\n\t\t\t{\n\t\t\t\t//console.dir(ls);\n\n\t\t\t\treturn novelGlobby.globToListArrayDeep(ls, globby_options)\n\t\t\t})\n\t\t\t.tap(function (ls)\n\t\t\t{\n\t\t\t\t/*\n\t\t\t\tconsole.dir(ls, {\n\t\t\t\t\tdepth: null,\n\t\t\t\t\tcolors: true,\n\t\t\t\t});\n\t\t\t\tprocess.exit();\n\t\t\t */\n\n\t\t\t\treturn ls;\n\t\t\t})\n\t\t\t.then(_ls =>\n\t\t\t{\n\t\t\t\t//let idx = 1;\n\n\t\t\t\t//let cacheTreeSection = {} as Record<string, EpubMaker.Section>;\n\n\t\t\t\t//const SymCache = Symbol('cache');\n\n\t\t\t\t//let _new_top_level: EpubMaker.Section;\n\t\t\t\t//let _old_top_level: EpubMaker.Section;\n\n\t\t\t\treturn foreachArrayDeepAsync(_ls as IArrayDeepInterface<IReturnRow>, async ({\n\t\t\t\t\tvalue,\n\t\t\t\t\tindex,\n\t\t\t\t\tarray,\n\t\t\t\t\tcache,\n\t\t\t\t}) =>\n\t\t\t\t{\n\t\t\t\t\tconst { volume_title, chapter_title } = value;\n\t\t\t\t\tconst { temp, data } = cache;\n\t\t\t\t\tconst { stat } = data;\n\n\t\t\t\t\tconst { cacheTreeSection } = temp;\n\n\t\t\t\t\t/**\n\t\t\t\t\t * 去除掉排序ID後的章節名稱\n\t\t\t\t\t */\n\t\t\t\t\tlet vs_ret = eachVolumeTitle(volume_title, true);\n\t\t\t\t\t/**\n\t\t\t\t\t * 章節名稱 含 排序用的ID 來避免同一個資料夾下 有兩個相同 章節名稱\n\t\t\t\t\t */\n\t\t\t\t\tlet vs_ret2 = eachVolumeTitle(value.dir, false);\n\n\t\t\t\t\tconst dirname = value.path_dir;\n\n\t\t\t\t\tlet _ds = (path.normalize(dirname) as string).split('/');\n\n\t\t\t\t\tconst volume: IEpubMakerSectionWithCache = await Bluebird\n\t\t\t\t\t\t.resolve(vs_ret2.titles_full)\n\t\t\t\t\t\t.reduce(async function (vp: IEpubMakerSectionWithCache, key, index)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet title = vs_ret.titles[index];\n\n\t\t\t\t\t\t\tkey += '.dir';\n\n\t\t\t\t\t\t\tif (\n\t\t\t\t\t\t\t\t0\n\t\t\t\t\t\t\t\t&& temp.prev_volume_dir\n\t\t\t\t\t\t\t\t&& temp.prev_volume_dir != dirname\n\t\t\t\t\t\t\t\t&& (\n\t\t\t\t\t\t\t\t\tdirname.length < temp.prev_volume_dir.length\n\t\t\t\t\t\t\t\t\t//|| temp.prev_volume_dir.indexOf(dirname) == -1\n\t\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tawait _handleVolumeImage(temp.prev_volume, temp.prev_volume_row.dirname, {\n\t\t\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\t\t\tprocessReturn: cache,\n\t\t\t\t\t\t\t\t\tepubOptions: options,\n\t\t\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\t\t\tcwdRoot: TXT_PATH,\n\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t\t.tap(ls =>\n\t\t\t\t\t\t\t\t\t{\n\n\t\t\t\t\t\t\t\t\t\tconsole.log(ls);\n\n\t\t\t\t\t\t\t\t\t\tif (ls.length)\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tconsole.log({\n\n\t\t\t\t\t\t\t\t\t\t\t\tprev_volume_dir: temp.prev_volume_dir,\n\t\t\t\t\t\t\t\t\t\t\t\tdirname,\n\n\t\t\t\t\t\t\t\t\t\t\t\tlen: dirname.length < temp.prev_volume_dir.length,\n\t\t\t\t\t\t\t\t\t\t\t\tindexOf: temp.prev_volume_dir.indexOf(dirname),\n\t\t\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tlet vc: IEpubMakerSectionWithCache;\n\n\t\t\t\t\t\t\tif (temp.cache_vol[key] == null)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlet _nav_dir = _ds.slice(0, _ds.length - vs_ret.level + index + 1).join('/');\n\n\t\t\t\t\t\t\t\t//data.toc.push('- '.repeat(index + 1) + title);\n\n\t\t\t\t\t\t\t\t/*\n\t\t\t\t\t\t\t\tconsole.log({\n\t\t\t\t\t\t\t\t\tkey,\n\t\t\t\t\t\t\t\t\t_nav_dir,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t */\n\n\t\t\t\t\t\t\t\ttemp.count_d++;\n\t\t\t\t\t\t\t\tstat.volume++;\n\n\t\t\t\t\t\t\t\ttemp.cache_vol[key] = (temp.cache_vol[key] | 0);\n\n\t\t\t\t\t\t\t\tlet vid = makeVolumeID(temp.count_idx++);\n\n\t\t\t\t\t\t\t\tvc = cacheTreeSection[key] = new EpubMaker.Section('auto-toc', vid, {\n\t\t\t\t\t\t\t\t\ttitle: title,\n\t\t\t\t\t\t\t\t}, false, true);\n\n\t\t\t\t\t\t\t\tvc[SymCache] = vc[SymCache] || {};\n\n\t\t\t\t\t\t\t\tawait _handleVolume(vc, _nav_dir, {\n\t\t\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\t\t\tepubOptions: options,\n\t\t\t\t\t\t\t\t\tprocessReturn: cache,\n\t\t\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\t\t\tcwdRoot: TXT_PATH,\n\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\tif (index == 0)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tif (temp._old_top_level)\n\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\tawait _handleVolumeImageEach(temp.cache_top_subs[temp._old_top_level.id], {\n\t\t\t\t\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\t\t\t\t\tprocessReturn: cache,\n\t\t\t\t\t\t\t\t\t\t\tepubOptions: options,\n\t\t\t\t\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\t\t\t\t\tcwdRoot: TXT_PATH,\n\t\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\t\tif (!epub.hasSection(temp._old_top_level))\n\t\t\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\t\t\tepub.withSection(temp._old_top_level);\n\t\t\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\t\t\ttemp._old_top_level = temp._new_top_level;\n\t\t\t\t\t\t\t\t\ttemp._new_top_level = vc;\n\n\t\t\t\t\t\t\t\t\ttemp.cache_top_subs[vc.id] = temp.cache_top_subs[vc.id] || [];\n\n\t\t\t\t\t\t\t\t\ttemp.cache_top_subs[vc.id].push({\n\t\t\t\t\t\t\t\t\t\tvol_key: key,\n\t\t\t\t\t\t\t\t\t\tdirname: _nav_dir,\n\t\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tvc = cacheTreeSection[key];\n\n\t\t\t\t\t\t\tif (vp && !vp.hasSubSection(vc))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tvp.withSubSection(vc);\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn vc\n\t\t\t\t\t\t}, null)\n\t\t\t\t\t;\n\n\t\t\t\t\tconst row = value;\n\n\t\t\t\t\tlet name = value.chapter_title;\n\n\t\t\t\t\tlet txt = await fs.loadFile(value.path, {\n\t\t\t\t\t\t\tautoDecode: true,\n\t\t\t\t\t\t})\n\t\t\t\t\t\t.then(async function (data)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tlet txt = crlf(data.toString());\n\n\t\t\t\t\t\t\tif (value.ext == '.txt')\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tlet attach = await getAttachMetaByRow(row);\n\n\t\t\t\t\t\t\t\treturn splitTxt(txt, {\n\t\t\t\t\t\t\t\t\tattach,\n\t\t\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\t\t\tvid: volume.id,\n\t\t\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\t\t\tepubOptions: options,\n\t\t\t\t\t\t\t\t\tcwd: dirname,\n\t\t\t\t\t\t\t\t\tcwdRoot: TXT_PATH,\n\t\t\t\t\t\t\t\t});\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\treturn txt;\n\t\t\t\t\t\t})\n\t\t\t\t\t;\n\n\t\t\t\t\tif (!options.noLog)\n\t\t\t\t\t{\n\t\t\t\t\t\tlet {\n\t\t\t\t\t\t\tsource_idx,\n\t\t\t\t\t\t\tvolume_title,\n\t\t\t\t\t\t\tchapter_title,\n\t\t\t\t\t\t\tdir,\n\t\t\t\t\t\t\tfile,\n\t\t\t\t\t\t} = row;\n\n\t\t\t\t\t\tconsole.dir({\n\t\t\t\t\t\t\tsource_idx,\n\t\t\t\t\t\t\tvolume_title,\n\t\t\t\t\t\t\tchapter_title,\n\t\t\t\t\t\t\tdir,\n\t\t\t\t\t\t\tfile,\n\t\t\t\t\t\t});\n\t\t\t\t\t}\n\n\t\t\t\t\tlet chapter = new EpubMaker.Section(EnumEpubTypeName.CHAPTER, makeChapterID(temp.count_idx++), {\n\t\t\t\t\t\ttitle: name,\n\t\t\t\t\t\tcontent: txt,\n\t\t\t\t\t}, true, false);\n\n\t\t\t\t\tstat.chapter++;\n\n\t\t\t\t\tvolume.withSubSection(chapter);\n\n\t\t\t\t\tlet vi = vs_ret.level - 1;\n\n\t\t\t\t\tlet vol_key = vs_ret2.titles_full[vi];\n\n\t\t\t\t\ttemp.cache_vol[vol_key]++;\n\t\t\t\t\ttemp.prev_volume_title = volume_title;\n\t\t\t\t\ttemp.prev_volume_dir = dirname;\n\t\t\t\t\ttemp.prev_volume = volume;\n\n\t\t\t\t\ttemp.prev_volume_row = {\n\t\t\t\t\t\tvol_key: vol_key + '.dir',\n\t\t\t\t\t\tdirname,\n\t\t\t\t\t\tvalue,\n\t\t\t\t\t};\n\n\t\t\t\t\ttemp.\n\t\t\t\t\tcache_volume_row.push(temp.prev_volume_row);\n\n\t\t\t\t\treturn volume;\n\n\t\t\t\t}, <IEpubRuntimeReturn>{\n\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tstat: {\n\t\t\t\t\t\t\tvolume: 0,\n\t\t\t\t\t\t\tchapter: 0,\n\t\t\t\t\t\t\timage: 0,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\n\t\t\t\t\ttemp: {\n\t\t\t\t\t\tcache_vol: {},\n\n\t\t\t\t\t\tprev_volume_title: null,\n\t\t\t\t\t\tprev_volume_dir: null,\n\n\t\t\t\t\t\tprev_volume: null,\n\n\t\t\t\t\t\tprev_volume_row: null,\n\n\t\t\t\t\t\tcache_top_subs: {},\n\n\t\t\t\t\t\tcache_volume_row: [],\n\n\t\t\t\t\t\tcount_idx: count_idx,\n\t\t\t\t\t\tcount_f: 0,\n\t\t\t\t\t\tcount_d: 0,\n\n\t\t\t\t\t\tcacheTreeSection: {},\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t\t\t.tap(async (processReturn: IEpubRuntimeReturn) =>\n\t\t\t\t\t{\n\t\t\t\t\t\tconst { temp } = processReturn;\n\n\t\t\t\t\t\t/*\n\t\t\t\t\t\tawait _handleVolumeImageEach(temp.cache_volume_row, {\n\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\tprocessReturn,\n\t\t\t\t\t\t\tepubOptions: options,\n\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\tcwdRoot: TXT_PATH,\n\t\t\t\t\t\t});\n\t\t\t\t\t\t */\n\n\t\t\t\t\t\tawait _hookAfterVolume(temp.cache_volume_row, {\n\t\t\t\t\t\t\tepub,\n\t\t\t\t\t\t\tprocessReturn,\n\t\t\t\t\t\t\tepubOptions: options,\n\t\t\t\t\t\t\tstore,\n\t\t\t\t\t\t\tcwdRoot: TXT_PATH,\n\t\t\t\t\t\t}, [\n\t\t\t\t\t\t\t_handleVolumeImage,\n\t\t\t\t\t\t\taddContributeSection,\n\t\t\t\t\t\t]);\n\n\t\t\t\t\t\tif (temp._old_top_level && !epub.hasSection(temp._old_top_level))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tepub.withSection(temp._old_top_level);\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (temp._new_top_level && !epub.hasSection(temp._new_top_level))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tepub.withSection(temp._new_top_level);\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\t\t\t\t\t;\n\t\t\t})\n\t\t\t.tap(async (processReturn: IEpubRuntimeReturn) =>\n\t\t\t{\n\n\t\t\t\t_hookAfterEpub(epub, {\n\t\t\t\t\tepub,\n\t\t\t\t\tprocessReturn,\n\t\t\t\t\tepubOptions: options,\n\t\t\t\t\tstore,\n\t\t\t\t\tcwd: TXT_PATH,\n\t\t\t\t\tcwdRoot: TXT_PATH,\n\t\t\t\t}, [\n\n\t\t\t\t\tasync (epub, _data_) =>\n\t\t\t\t\t{\n\t\t\t\t\t\tconst { cwdRoot } = _data_;\n\n\t\t\t\t\t\tnovelGlobby.globby([\n\t\t\t\t\t\t\t\t'CONTRIBUTE.md',\n\t\t\t\t\t\t\t], {\n\t\t\t\t\t\t\t\tcwd: cwdRoot,\n\t\t\t\t\t\t\t\tabsolute: true,\n\t\t\t\t\t\t\t\tdeep: 0,\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t.then(async (ls) =>\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tif (ls.length)\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tlet file = ls[0];\n\n\t\t\t\t\t\t\t\t\tlet source = await fs.readFile(file);\n\n\t\t\t\t\t\t\t\t\tlet mdReturn = handleMarkdown(source, {\n\t\t\t\t\t\t\t\t\t\t..._data_,\n\t\t\t\t\t\t\t\t\t\tcwd: cwdRoot,\n\t\t\t\t\t\t\t\t\t});\n\n\t\t\t\t\t\t\t\t\tcreateContributeSection({\n\t\t\t\t\t\t\t\t\t\ttarget: epub,\n\t\t\t\t\t\t\t\t\t\tmdReturn,\n\t\t\t\t\t\t\t\t\t\tprocessReturn,\n\t\t\t\t\t\t\t\t\t})\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t})\n\t\t\t\t\t\t;\n\n\t\t\t\t\t},\n\n\t\t\t\t])\n\n\t\t\t})\n\t\t;\n\n\t\t//console.dir(epub.epubConfig.sections[0]);\n\t\t//console.dir(epub.epubConfig.landmarks.slice(0, 2));\n\t\t//process.exit();\n\n\t\tlet data = await epub.makeEpub();\n\n\t\tlet _file_data = makeFilename(options, epub, meta);\n\n\t\tlet { file, filename, now, basename, ext } = _file_data;\n\n\t\tawait fs.outputFile(file, data);\n\n\t\tconst stat = processReturn.data.stat;\n\n\t\tconsole.success(filename, now.format(), stat);\n\n\t\treturn {\n\t\t\tfile,\n\t\t\tfilename,\n\t\t\tepub,\n\n\t\t\toutputPath: options.outputPath,\n\n\t\t\tbasename,\n\t\t\text,\n\n\t\t\tstat,\n\n\t\t\tstore,\n\t\t};\n\t});\n}\n\nexport function makeFilename(options: IOptions, epub: EpubMaker, meta: IMdconfMeta)\n{\n\toptions = makeOptions(options);\n\n\tlet filename = epub.getFilename(options.useTitle, true);\n\n\tif (!options.filename)\n\t{\n\t\tif (options.filenameLocal)\n\t\t{\n\t\t\t// @ts-ignore\n\t\t\tif (meta.novel.title_output)\n\t\t\t{\n\t\t\t\t// @ts-ignore\n\t\t\t\tfilename = meta.novel.title_output;\n\t\t\t}\n\t\t\telse if (Array.isArray(options.filenameLocal))\n\t\t\t{\n\t\t\t\tfor (let v of options.filenameLocal)\n\t\t\t\t{\n\t\t\t\t\tif (meta.novel[v])\n\t\t\t\t\t{\n\t\t\t\t\t\tfilename = meta.novel[v];\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\telse if (meta.novel.title_zh)\n\t\t\t{\n\t\t\t\tfilename = meta.novel.title_zh;\n\t\t\t}\n\t\t\telse if (meta.novel.title_short)\n\t\t\t{\n\t\t\t\tfilename = meta.novel.title_short;\n\t\t\t}\n\t\t\telse if (meta.novel.title_tw)\n\t\t\t{\n\t\t\t\tfilename = meta.novel.title_tw;\n\t\t\t}\n\t\t\telse if (typeof options.filenameLocal == 'string')\n\t\t\t{\n\t\t\t\tfilename = options.filenameLocal;\n\t\t\t}\n\t\t}\n\t}\n\n\tconst basename = filename;\n\n\tlet ext = EpubMaker.defaultExt;\n\n\tlet now = moment();\n\n\tif (options.padEndDate)\n\t{\n\t\tfilename += '_' + now.format('YYYYMMDD_HHmmss');\n\t}\n\n\tfilename += ext;\n\n\tlet file = path.join(options.outputPath, filename);\n\n\treturn {\n\t\tfile,\n\t\text,\n\t\tfilename,\n\t\toptions,\n\t\tnow,\n\t\tbasename,\n\t\tepub,\n\t\tmeta,\n\t}\n}\n\nexport default create;\n"]}