{"version":3,"file":"store.js","sourceRoot":"","sources":["store.ts"],"names":[],"mappings":"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","sourcesContent":["import { EpubMaker, hashSum, slugify } from 'epub-maker2';\nimport * as path from 'path';\nimport LazyURL from 'lazy-url';\nimport { pathExistsSync, realpathSync } from 'fs-extra';\nimport execall from 'execall2';\nimport { transliterate as tr, slugify as tr_slugify } from 'transliteration';\nimport { IAttachMetaData } from './epub';\nimport { IOptions } from './txt2epub3';\nimport { toHalfWidth } from 'str-util';\nimport { IInternalProcessOptions } from './types';\nimport { console } from './log';\nimport { novelImage } from './html';\nimport { ParsedPath } from \"path\";\nimport { allowExtImage, isAllowExtImage } from './ext';\nimport { pathAtParent } from './util';\n\nexport interface IEpubStoreValue\n{\n\tuuid: string,\n\tvid: string,\n\tbasePath: string,\n\text: string,\n\tbasename: string,\n\tvalue: string,\n\tisFile: boolean,\n\toldExt: string,\n\tinput: string,\n}\n\nexport interface IEpubStoreOptions\n{\n\tvid: string,\n\tbasePath?: string,\n\tname?: string,\n\text?: string,\n\n\tchkExt?(ext: string): boolean;\n\tfailbackExt?: string,\n\tfailbackName?: string,\n\n\tcwd: string,\n\tcwdRoot: string,\n}\n\nexport class EpubStore\n{\n\n\tprotected $cache = new Map<string, IEpubStoreValue>();\n\tprotected $names = new Set<string>();\n\tprotected $exists = new WeakSet<IEpubStoreValue>();\n\n\t_name(_data: ReturnType<typeof parsePath>, options: IEpubStoreOptions)\n\t{\n\t\tconst { input, isFile } = _data;\n\n\t\tif (!this.$cache.has(input))\n\t\t{\n\t\t\tlet { name = _data.name, ext = _data.ext, vid, basePath, chkExt = defaultChkExt, failbackExt, failbackName } = options;\n\t\t\tlet i = 0;\n\n\t\t\tname = name || _data.name;\n\n\t\t\ttry\n\t\t\t{\n\t\t\t\tname = tr_slugify(name).trim().slice(0, 22).trim() || name;\n\t\t\t}\n\t\t\tcatch (e)\n\t\t\t{\n\t\t\t}\n\n\t\t\tlet cur_name = name;\n\n\t\t\tif (isBadName(name) || isHashedLike(name))\n\t\t\t{\n\t\t\t\tif (failbackName)\n\t\t\t\t{\n\t\t\t\t\tcur_name = name = failbackName;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tname = 'img_';\n\t\t\t\t\tcur_name = name + (++i).toString().padStart(3, '0');\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tlet oldExt = ext;\n\n\t\t\tif (failbackExt && chkExt(ext))\n\t\t\t{\n\t\t\t\text = failbackExt;\n\t\t\t}\n\n\t\t\tlet value: string;\n\t\t\tlet basename: string;\n\n\t\t\tdo\n\t\t\t{\n\t\t\t\tbasename = cur_name;\n\t\t\t\tvalue = `${vid}/${cur_name}${ext}`;\n\t\t\t\tcur_name = name + (++i).toString().padStart(3, '0');\n\t\t\t}\n\t\t\twhile (this.$names.has(value));\n\n\t\t\tthis.$names.add(value);\n\n\t\t\tthis.$cache.set(input, {\n\t\t\t\tuuid: input,\n\t\t\t\tinput,\n\t\t\t\tvid,\n\t\t\t\tbasePath,\n\t\t\t\text,\n\t\t\t\tbasename,\n\t\t\t\tvalue,\n\t\t\t\tisFile,\n\t\t\t\toldExt,\n\t\t\t})\n\t\t}\n\n\t\treturn this.$cache.get(input)\n\t}\n\n\tget(input: string, options: IEpubStoreOptions)\n\t{\n\t\tlet _data = parsePath(input, options);\n\n\t\tif (_data)\n\t\t{\n\t\t\treturn this._name(_data, options)\n\t\t}\n\t}\n\n\tadd(data: IEpubStoreValue)\n\t{\n\t\tthis.$exists.add(data)\n\t}\n\n\texists(data: IEpubStoreValue)\n\t{\n\t\treturn this.$exists.has(data)\n\t}\n\n}\n\nexport function defaultChkExt(ext: string)\n{\n\treturn !ext || ext === '.' || /php|cgi|htm|js|ts/i.test(ext);\n}\n\nexport function isBadName(input: string)\n{\n\treturn /index|^img$|\\d{10,}/i.test(input) || isEncodeURI(input)\n}\n\nexport function isHashedLike(input: string, maxCount: number = 3)\n{\n\tlet r = execall(/([a-f][0-9]|[0-9][a-f])/ig, input);\n\n\treturn r.length >= maxCount;\n}\n\nexport function isEncodeURI(input: string, maxCount: number = 3)\n{\n\tlet r = execall(/(%[0-9a-f]{2,})/ig, input);\n\n\treturn r.length >= maxCount;\n}\n\n/**\n *\n * @example console.dir(parsePath(__filename))\n * @example console.dir(parsePath('https://xs.dmzj.com/img/1406/79/a7e62ec50db1db823c61a2127aec9827.jpg'))\n */\nexport function parsePath(input: string, options: IEpubStoreOptions)\n{\n\tconst { cwd, cwdRoot } = options;\n\n\ttry\n\t{\n\t\tconst isFile = true as const;\n\t\tlet tempInput: string;\n\n\t\tif (cwd && pathExistsSync(tempInput = path.resolve(cwd, input)))\n\t\t{\n\t\t\tlet data = path.parse(tempInput);\n\t\t\tlet { ext, name } = data;\n\n\t\t\tname = decodeURIComponent(name);\n\n\t\t\treturn _fn001({\n\t\t\t\tname,\n\t\t\t\text,\n\t\t\t\tdata,\n\t\t\t})\n\t\t}\n\t\telse if (pathExistsSync(tempInput = path.resolve(input)))\n\t\t{\n\t\t\tlet data = path.parse(tempInput);\n\t\t\tlet { ext, name } = data;\n\n\t\t\tname = decodeURIComponent(name);\n\n\t\t\treturn _fn001({\n\t\t\t\tname,\n\t\t\t\text,\n\t\t\t\tdata,\n\t\t\t})\n\t\t}\n\t\telse if (pathExistsSync(tempInput = realpathSync(input)))\n\t\t{\n\t\t\tlet data = path.parse(tempInput);\n\t\t\tlet { ext, name } = data;\n\n\t\t\tname = decodeURIComponent(name);\n\n\t\t\treturn _fn001({\n\t\t\t\tname,\n\t\t\t\text,\n\t\t\t\tdata,\n\t\t\t})\n\t\t}\n\n\t\tfunction _fn001({\n\t\t\tname,\n\t\t\text,\n\t\t\tdata,\n\t\t}: {\n\t\t\tname: string,\n\t\t\text: string,\n\t\t\tdata: ParsedPath,\n\t\t})\n\t\t{\n\t\t\t/**\n\t\t\t * 當使用本地圖片時只允許指定的副檔名\n\t\t\t */\n\t\t\tif (isFile)\n\t\t\t{\n\t\t\t\tif (!isAllowExtImage(ext))\n\t\t\t\t{\n\t\t\t\t\tconsole.error(`'${ext}' 副導名不在允許清單內, ${allowExtImage}`);\n\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t\telse if (!pathAtParent(tempInput, cwdRoot))\n\t\t\t\t{\n\t\t\t\t\tconsole.error(`檔案路徑必須要存在於目前小說資料夾下，不允許讀取其他資料夾\\n${cwdRoot}\\n${tempInput}`);\n\n\t\t\t\t\treturn null;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tisFile,\n\t\t\t\tinput: tempInput,\n\t\t\t\text,\n\t\t\t\tname,\n\t\t\t\tdata,\n\t\t\t}\n\t\t}\n\t}\n\tcatch (e)\n\t{\n\n\t}\n\n\ttry\n\t{\n\t\tconst isFile = false as const;\n\n\t\tlet u = new URL(input);\n\n\t\tif (u.protocol && u.host)\n\t\t{\n\t\t\tlet pathname = decodeURIComponent(u.pathname);\n\n\t\t\tlet ext = path.extname(pathname);\n\t\t\tlet name = path.basename(pathname, ext);\n\n\t\t\tlet data = new LazyURL(u).toObject();\n\n\t\t\tif (!name)\n\t\t\t{\n\t\t\t\tname = hashSum(input)\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\tisFile,\n\t\t\t\tinput,\n\t\t\t\text,\n\t\t\t\tname,\n\t\t\t\tdata,\n\t\t\t}\n\t\t}\n\t}\n\tcatch (e)\n\t{\n\n\t}\n\n\treturn null;\n}\n\nexport interface IHandleAttachFileOptions extends IEpubStoreOptions, IInternalProcessOptions\n{\n\n}\n\nexport function handleAttachFile(input: string, plusData?: IHandleAttachFileOptions)\n{\n\tconst { store, vid, epub, epubOptions, failbackExt, failbackName } = plusData || {};\n\n\tlet data = store.get(input, {\n\t\t...plusData,\n\t\tvid,\n\t\tfailbackExt,\n\t});\n\n\tif (data)\n\t{\n\t\tlet { value, input, basePath } = data;\n\n\t\tif (typeof basePath === 'undefined')\n\t\t{\n\t\t\tbasePath = plusData.basePath;\n\t\t}\n\n\t\tlet returnPath: string;\n\n\t\tif (basePath == null)\n\t\t{\n\t\t\treturnPath = `${value}`;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturnPath = `${basePath}/${value}`;\n\t\t}\n\n\t\tif (!data.isFile)\n\t\t{\n\t\t\tif (!epubOptions.downloadRemoteFile)\n\t\t\t{\n\t\t\t\treturnPath = input;\n\n\t\t\t\treturn {\n\t\t\t\t\tok: false as const,\n\t\t\t\t\treturnPath,\n\t\t\t\t\tinput,\n\t\t\t\t\tvalue,\n\t\t\t\t\tbasePath,\n\t\t\t\t\tisFile: data.isFile as false,\n\t\t\t\t\tdata,\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\n\t\tif (!store.exists(data))\n\t\t{\n\t\t\tepub.withAdditionalFile(input, basePath, value);\n\t\t\tstore.add(data);\n\t\t}\n\n\t\treturn {\n\t\t\tok: true as const,\n\t\t\treturnPath,\n\t\t\tinput,\n\t\t\tvalue,\n\t\t\tbasePath,\n\t\t\tisFile: data.isFile,\n\t\t\tdata,\n\t\t}\n\t}\n}\n\nexport function getAttachID(id: string, attach: IAttachMetaData, returnFailbackObject?: boolean): {\n\tid: string,\n\tinput: string,\n}\n{\n\tconst { images } = attach || {} as IAttachMetaData;\n\tid = toHalfWidth(id).trim();\n\n\tif (!images[id])\n\t{\n\t\tid = id.toLowerCase()\n\t}\n\n\tif (!images[id])\n\t{\n\t\tid = id.toUpperCase()\n\t}\n\n\tlet input = images[id];\n\n\tif (input && typeof input === 'string' && (input = input.trim()))\n\t{\n\t\treturn {\n\t\t\tid, input,\n\t\t}\n\t}\n\n\treturn {} as any\n}\n"]}