{"version":3,"file":"md.js","sourceRoot":"","sources":["md.ts"],"names":[],"mappings":"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","sourcesContent":["/**\n * Created by user on 2019/7/22.\n */\n\nimport MarkdownIt = require('markdown-it');\nimport { defaultsDeep } from 'lodash';\nimport { IInternalProcessContextOptions, IInternalProcessMarkdownItOptions } from './types';\nimport fs from 'fs-iconv';\nimport { buffer } from 'extract-bad-epub/lib/index';\nimport * as path from 'path';\nimport { ITSResolvable, ITSPartialWith, ITSUnpackedPromiseLike } from 'ts-type';\n\nimport { HTML_OPEN_CLOSE_TAG_RE } from 'markdown-it/lib/common/html_re';\n\nexport function createMarkdownIt(options?: MarkdownIt.Options, plusData?: Partial<IInternalProcessMarkdownItOptions>)\n{\n\toptions = defaultsDeep({}, options, <MarkdownIt.Options>{\n\t\thtml: true,\n\t\tlinkify: true,\n\t\tbreaks: true,\n\t\txhtmlOut: true,\n\t});\n\n\treturn new MarkdownIt(options)\n\n\t\t.use(require('markdown-it-ruby'))\n\t\t.use(require('markdown-it-footnote'))\n\t\t.use(require('markdown-it-emoji'))\n\t\t.use(require(\"markdown-it-toc-and-anchor\").default)\n\t\t.use(require('markdown-it-title'))\n\t\t.use(require('markdown-it-implicit-figures'), {\n\t\t\tdataType: true,\n\t\t\tfigcaption: true,\n\t\t})\n\t\t.use(require('@toycode/markdown-it-class'), {\n\t\t\tfigure: [\n\t\t\t\t//'fullpage',\n\t\t\t\t'ImageContainer',\n\t\t\t\t'page-break-before',\n\t\t\t\t'duokan-image-single',\n\t\t\t],\n\t\t\timg: [\n\t\t\t\t'inner-image',\n\t\t\t],\n\t\t\thr: [\n\t\t\t\t'linehr',\n\t\t\t],\n\t\t\tp: [\n\t\t\t\t'linegroup',\n\t\t\t\t'calibre1',\n\t\t\t],\n\t\t\th1: [\n\t\t\t\t'left',\n\t\t\t],\n\t\t\th2: [\n\t\t\t\t'left',\n\t\t\t],\n\t\t\th3: [\n\t\t\t\t'left',\n\t\t\t],\n\t\t\th4: [\n\t\t\t\t'left',\n\t\t\t],\n\t\t\th5: [\n\t\t\t\t'left',\n\t\t\t],\n\t\t\th6: [\n\t\t\t\t'left',\n\t\t\t],\n\t\t})\n\t\t;\n}\n\nexport function render(input: string, options: Partial<IInternalProcessMarkdownItOptions> = {}): string\n{\n\tif (!options.md || options.mdOptions)\n\t{\n\t\toptions.md = createMarkdownIt(options.mdOptions, options)\n\t\t;\n\n\t\t/**\n\t\t * unsafe\n\t\t * disable until fix markdown-it-include\n\t\t *\n\t\t * @todo 由於可以做到載入非此小說路徑下的檔案 所以停用此功能 直到有空弄個 fork 版 markdown-it-include\n\t\t */\n\t\tif (0)\n\t\t{\n\t\t\t/*\n\t\t\toptions.md = options.md.use(require('markdown-it-include'), {\n\t\t\troot: options.cwd,\n\t\t})\n\t\t\t */\n\t\t}\n\t}\n\n\toptions.mdEnv = options.mdEnv || {};\n\n\tlet html = options.md.render(input, options.mdEnv);\n\n\t// @ts-ignore\n\tif (options.md.options.xhtmlOut)\n\t{\n\t\thtml = html\n\t\t\t.replace(/<br\\s*>/ig, '<br/>')\n\t}\n\n\treturn html\n\t\t.replace(/(<p(?:\\s\\w=\"[\\w\\s]*\")*>.+?)<\\/p>/igs, '$1</p>\\n<br/>')\n\t\t.replace(/(<p(?:\\s\\w=\"[\\w\\s]*\")*>)<\\/p>/ig, '<p class=\"linegroup calibre1\">$1　 </p>')\n\t\t.replace(/<p(?=\\s|>)/ig, '<div')\n\t\t.replace(/<\\/\\s*p>/ig, '</div>')\n\t\t;\n}\n\nexport function handleMarkdown(txt: Buffer | string, plusData?: IInternalProcessMarkdownItOptions)\n{\n\tdefaultsDeep(plusData = plusData || {} as any, {\n\t\tmd: null,\n\t\tmdEnv: {},\n\t});\n\n\tif (Buffer.isBuffer(txt))\n\t{\n\t\ttxt = txt.toString();\n\t}\n\n\tlet mdHtml = render(txt, plusData);\n\n\treturn {\n\t\tplusData,\n\t\tmdEnv: plusData.mdEnv,\n\t\tmdHtml,\n\t}\n}\n"]}